<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MarAzul - DiagnÃ³stico Completo</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { 
      padding: 20px; 
      background: #f8f9fa; 
    }
    .test-section {
      background: white;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      border-left: 4px solid #003366;
    }
    .test-result {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      font-family: monospace;
      font-size: 14px;
    }
    .success {
      background: #d1e7dd;
      border-left: 4px solid #0f5132;
    }
    .error {
      background: #f8d7da;
      border-left: 4px solid #842029;
    }
    .warning {
      background: #fff3cd;
      border-left: 4px solid #997404;
    }
    .info {
      background: #cff4fc;
      border-left: 4px solid #055160;
    }
    .code {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      font-family: monospace;
      font-size: 13px;
    }
  </style>
</head>
<body>

<div class="container">
  <h1 class="mb-4">ğŸ” DiagnÃ³stico Completo - MarAzul</h1>
  <p class="text-muted">Este script identifica exactamente dÃ³nde estÃ¡ el problema del login</p>

  <div id="results"></div>

  <div class="test-section">
    <h3>ğŸ§ª Acciones de Prueba</h3>
    <button class="btn btn-primary me-2" onclick="simulateLogin()">Simular Login</button>
    <button class="btn btn-success me-2" onclick="forceUpdateHeader()">Forzar ActualizaciÃ³n Header</button>
    <button class="btn btn-danger me-2" onclick="clearAll()">Limpiar Todo</button>
    <button class="btn btn-secondary" onclick="runDiagnostic()">Re-ejecutar DiagnÃ³stico</button>
  </div>
</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Scripts MarAzul -->
<script src="js/config.js"></script>
<script src="js/utils.js"></script>
<script src="js/auth.js"></script>
<script src="js/cart.js"></script>
<script src="js/api.js"></script>

<script>
let results = [];

function log(message, type = 'info') {
  results.push({ message, type, timestamp: new Date().toLocaleTimeString() });
  updateResults();
}

function updateResults() {
  const container = document.getElementById('results');
  container.innerHTML = results.map(r => `
    <div class="test-result ${r.type}">
      <strong>[${r.timestamp}]</strong> ${r.message}
    </div>
  `).join('');
  container.scrollTop = container.scrollHeight;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TEST 1: VERIFICAR VERSIÃ“N DE AUTH.JS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function test1_CheckAuthVersion() {
  log('â•â•â• TEST 1: Verificar versiÃ³n de auth.js â•â•â•', 'info');
  
  // Verificar si existe checkRecentLoginAndUpdate
  if (typeof checkRecentLoginAndUpdate === 'function') {
    log('âœ… CORRECTO: checkRecentLoginAndUpdate existe (auth.js v1.2.1)', 'success');
    return true;
  } else {
    log('âŒ ERROR: checkRecentLoginAndUpdate NO existe', 'error');
    log('âš ï¸  Tienes una versiÃ³n antigua de auth.js', 'warning');
    log('ğŸ“‹ SOLUCIÃ“N: Reemplaza auth.js con auth-actualizado.js', 'warning');
    return false;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TEST 2: VERIFICAR FUNCIONES DISPONIBLES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function test2_CheckFunctions() {
  log('â•â•â• TEST 2: Verificar funciones disponibles â•â•â•', 'info');
  
  const requiredFunctions = [
    'getCurrentUser',
    'setCurrentUser',
    'getAuthToken',
    'setAuthToken',
    'isAuthenticated',
    'initHeader',
    'renderUserDropdown',
    'renderLoginButton',
    'updateCartBadge',
    'checkRecentLoginAndUpdate'
  ];
  
  let allOk = true;
  
  requiredFunctions.forEach(funcName => {
    if (typeof window[funcName] === 'function') {
      log(`âœ… ${funcName} existe`, 'success');
    } else {
      log(`âŒ ${funcName} NO existe`, 'error');
      allOk = false;
    }
  });
  
  return allOk;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TEST 3: VERIFICAR LOCALSTORAGE ACTUAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function test3_CheckLocalStorage() {
  log('â•â•â• TEST 3: Verificar localStorage actual â•â•â•', 'info');
  
  const user = localStorage.getItem('marazul_current_user');
  const token = localStorage.getItem('marazul_auth_token');
  const flag = localStorage.getItem('marazul_recent_login');
  
  log('ğŸ“¦ marazul_current_user: ' + (user ? 'EXISTE (' + user.substring(0, 50) + '...)' : 'NULL'), user ? 'success' : 'warning');
  log('ğŸ“¦ marazul_auth_token: ' + (token ? 'EXISTE (' + token.substring(0, 30) + '...)' : 'NULL'), token ? 'success' : 'warning');
  log('ğŸ“¦ marazul_recent_login: ' + (flag || 'NULL'), flag ? 'success' : 'warning');
  
  if (user && token) {
    try {
      const userObj = JSON.parse(user);
      log('âœ… Usuario parseado correctamente: ' + userObj.email, 'success');
      return true;
    } catch (e) {
      log('âŒ Error parseando usuario: ' + e.message, 'error');
      return false;
    }
  } else {
    log('âš ï¸  No hay usuario guardado en localStorage', 'warning');
    return false;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TEST 4: PROBAR getCurrentUser()
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function test4_TestGetCurrentUser() {
  log('â•â•â• TEST 4: Probar getCurrentUser() â•â•â•', 'info');
  
  try {
    const user = getCurrentUser();
    
    if (user) {
      log('âœ… getCurrentUser() retorna: ' + JSON.stringify(user), 'success');
      return true;
    } else {
      log('âš ï¸  getCurrentUser() retorna NULL', 'warning');
      return false;
    }
  } catch (e) {
    log('âŒ Error ejecutando getCurrentUser(): ' + e.message, 'error');
    return false;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TEST 5: PROBAR isAuthenticated()
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function test5_TestIsAuthenticated() {
  log('â•â•â• TEST 5: Probar isAuthenticated() â•â•â•', 'info');
  
  try {
    const authenticated = isAuthenticated();
    log('ğŸ“Š isAuthenticated() retorna: ' + authenticated, authenticated ? 'success' : 'warning');
    return authenticated;
  } catch (e) {
    log('âŒ Error ejecutando isAuthenticated(): ' + e.message, 'error');
    return false;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TEST 6: VERIFICAR #user-area
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function test6_CheckUserArea() {
  log('â•â•â• TEST 6: Verificar #user-area â•â•â•', 'info');
  
  const $userArea = $('#user-area');
  
  if ($userArea.length === 0) {
    log('âŒ #user-area NO existe en el DOM', 'error');
    log('âš ï¸  Necesitas cargar header.html primero', 'warning');
    return false;
  }
  
  log('âœ… #user-area existe', 'success');
  
  const html = $userArea.html();
  log('ğŸ“„ Contenido actual: ' + (html ? html.substring(0, 100) + '...' : 'VACÃO'), 'info');
  
  return true;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TEST 7: PROBAR initHeader() MANUALMENTE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function test7_TestInitHeader() {
  log('â•â•â• TEST 7: Probar initHeader() manualmente â•â•â•', 'info');
  
  try {
    initHeader();
    log('âœ… initHeader() ejecutado', 'success');
    
    setTimeout(() => {
      const $userArea = $('#user-area');
      const html = $userArea.html();
      
      if (html && html.includes('dropdown')) {
        log('âœ… Header actualizado a DROPDOWN', 'success');
      } else if (html && html.includes('Iniciar SesiÃ³n')) {
        log('âš ï¸  Header muestra botÃ³n de LOGIN', 'warning');
      } else {
        log('âŒ Header NO se actualizÃ³ correctamente', 'error');
      }
    }, 500);
    
    return true;
  } catch (e) {
    log('âŒ Error ejecutando initHeader(): ' + e.message, 'error');
    return false;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TEST 8: PROBAR checkRecentLoginAndUpdate()
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function test8_TestCheckRecentLogin() {
  log('â•â•â• TEST 8: Probar checkRecentLoginAndUpdate() â•â•â•', 'info');
  
  if (typeof checkRecentLoginAndUpdate !== 'function') {
    log('âŒ checkRecentLoginAndUpdate NO existe', 'error');
    return false;
  }
  
  try {
    checkRecentLoginAndUpdate();
    log('âœ… checkRecentLoginAndUpdate() ejecutado', 'success');
    return true;
  } catch (e) {
    log('âŒ Error ejecutando checkRecentLoginAndUpdate(): ' + e.message, 'error');
    return false;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SIMULAR LOGIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function simulateLogin() {
  log('â•â•â• ğŸ§ª SIMULANDO LOGIN â•â•â•', 'info');
  
  const testUser = {
    email: 'test@marazul.com',
    firstName: 'Test',
    lastName: 'User',
    id: '123'
  };
  
  const testToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.test.token';
  
  // Guardar directamente
  localStorage.setItem('marazul_current_user', JSON.stringify(testUser));
  localStorage.setItem('marazul_auth_token', testToken);
  localStorage.setItem('marazul_recent_login', 'true');
  
  log('âœ… Usuario de prueba guardado', 'success');
  log('âœ… Token de prueba guardado', 'success');
  log('âœ… Flag login reciente establecido', 'success');
  
  // Verificar
  setTimeout(() => {
    log('ğŸ”„ Verificando guardado...', 'info');
    test3_CheckLocalStorage();
    
    // Intentar actualizar header
    log('ğŸ”„ Intentando actualizar header...', 'info');
    if (typeof checkRecentLoginAndUpdate === 'function') {
      checkRecentLoginAndUpdate();
    } else {
      initHeader();
    }
  }, 500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FORZAR ACTUALIZACIÃ“N HEADER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function forceUpdateHeader() {
  log('â•â•â• ğŸ”„ FORZANDO ACTUALIZACIÃ“N HEADER â•â•â•', 'info');
  
  if ($('#user-area').length === 0) {
    log('âŒ No se puede actualizar: #user-area no existe', 'error');
    log('âš ï¸  Carga header.html primero', 'warning');
    return;
  }
  
  try {
    initHeader();
    log('âœ… initHeader() ejecutado', 'success');
    
    setTimeout(() => {
      const html = $('#user-area').html();
      log('ğŸ“„ HTML resultante: ' + (html ? html.substring(0, 200) : 'VACÃO'), 'info');
    }, 500);
  } catch (e) {
    log('âŒ Error: ' + e.message, 'error');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LIMPIAR TODO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function clearAll() {
  log('â•â•â• ğŸ§¹ LIMPIANDO TODO â•â•â•', 'info');
  
  localStorage.removeItem('marazul_current_user');
  localStorage.removeItem('marazul_auth_token');
  localStorage.removeItem('marazul_recent_login');
  
  log('âœ… localStorage limpio', 'success');
  
  if ($('#user-area').length > 0) {
    initHeader();
    log('âœ… Header actualizado', 'success');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EJECUTAR DIAGNÃ“STICO COMPLETO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function runDiagnostic() {
  results = [];
  log('ğŸ” INICIANDO DIAGNÃ“STICO COMPLETO...', 'info');
  log('', 'info');
  
  const test1 = test1_CheckAuthVersion();
  log('', 'info');
  
  const test2 = test2_CheckFunctions();
  log('', 'info');
  
  const test3 = test3_CheckLocalStorage();
  log('', 'info');
  
  const test4 = test4_TestGetCurrentUser();
  log('', 'info');
  
  const test5 = test5_TestIsAuthenticated();
  log('', 'info');
  
  const test6 = test6_CheckUserArea();
  log('', 'info');
  
  if (test6) {
    const test7 = test7_TestInitHeader();
    log('', 'info');
  }
  
  const test8 = test8_TestCheckRecentLogin();
  log('', 'info');
  
  // RESUMEN
  log('â•â•â• ğŸ“Š RESUMEN â•â•â•', 'info');
  
  if (!test1) {
    log('âŒ PROBLEMA: auth.js estÃ¡ desactualizado', 'error');
    log('ğŸ“‹ SOLUCIÃ“N: Instala auth-actualizado.js', 'warning');
  } else if (!test3) {
    log('âš ï¸  PROBLEMA: No hay datos en localStorage', 'warning');
    log('ğŸ“‹ SOLUCIÃ“N: Haz login o usa "Simular Login"', 'warning');
  } else if (test5 && !test6) {
    log('âš ï¸  PROBLEMA: Hay sesiÃ³n pero no hay header', 'warning');
    log('ğŸ“‹ SOLUCIÃ“N: Carga header.html primero', 'warning');
  } else if (test5 && test6) {
    log('âœ… TODO CORRECTO: El header DEBERÃA actualizarse', 'success');
    log('ğŸ”„ Si no se actualiza, usa "Forzar ActualizaciÃ³n Header"', 'info');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTO-EJECUTAR AL CARGAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
$(document).ready(function() {
  setTimeout(runDiagnostic, 1000);
});
</script>

</body>
</html>