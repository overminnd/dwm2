<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TEST - Componente 6: Cat√°logo Completo | MarAzul</title>
  
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  
  <!-- CSS del proyecto -->
  <link rel="stylesheet" href="css/style.css">
  
  <style>
    body {
      padding-top: 20px;
      background-color: #f8f9fa;
    }
    
    .test-header {
      background: linear-gradient(135deg, #003366 0%, #4db6ac 100%);
      color: white;
      padding: 30px 0;
      margin-bottom: 30px;
      border-radius: 10px;
    }
    
    .status-badge {
      display: inline-block;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      margin: 5px;
    }
    
    .status-success { background: #28a745; color: white; }
    .status-error { background: #dc3545; color: white; }
    
    .checklist {
      background: white;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .checklist h4 {
      color: #003366;
      margin-bottom: 20px;
      border-bottom: 2px solid #4db6ac;
      padding-bottom: 10px;
    }
    
    .checklist-item {
      padding: 10px;
      margin: 5px 0;
      border-left: 3px solid #e9ecef;
    }
    
    .code-block {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 5px;
      padding: 15px;
      margin: 10px 0;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      max-height: 400px;
      overflow-y: auto;
    }
    
    /* Estilos del cat√°logo */
    .catalogo-section {
      margin-bottom: 50px;
    }
    
    .catalogo-section h3 {
      color: #003366;
      border-bottom: 3px solid #4db6ac;
      padding-bottom: 10px;
    }
  </style>
</head>
<body>
  
  <div class="container">
    
    <!-- Header del Test -->
    <div class="test-header text-center">
      <h1>üß™ TEST - COMPONENTE 6</h1>
      <h2>Cat√°logo Completo</h2>
      <p class="mb-0">Prueba aislada del cat√°logo con 6 categor√≠as din√°micas</p>
    </div>
    
    <!-- Estado del Backend -->
    <div class="checklist">
      <h4>üì° Estado del Backend</h4>
      <div id="backend-status" class="text-center py-3">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Verificando...</span>
        </div>
        <p class="mt-2">Verificando conexi√≥n con backend...</p>
      </div>
    </div>
    
    <!-- Checklist de Verificaci√≥n -->
    <div class="checklist">
      <h4>‚úÖ Checklist de Verificaci√≥n</h4>
      
      <div class="checklist-item">
        <input type="checkbox" id="check1"> Se muestran 6 secciones de categor√≠as
      </div>
      <div class="checklist-item">
        <input type="checkbox" id="check2"> Cada secci√≥n tiene header con nombre de categor√≠a
      </div>
      <div class="checklist-item">
        <input type="checkbox" id="check3"> Headers tienen color #003366 y borde #4db6ac
      </div>
      <div class="checklist-item">
        <input type="checkbox" id="check4"> Productos se muestran en cada categor√≠a
      </div>
      <div class="checklist-item">
        <input type="checkbox" id="check5"> Cards tienen dise√±o horizontal (imagen 40% | contenido 60%)
      </div>
      <div class="checklist-item">
        <input type="checkbox" id="check6"> Grid responsive (3 columnas en desktop)
      </div>
      <div class="checklist-item">
        <input type="checkbox" id="check7"> Precios formateados correctamente
      </div>
      <div class="checklist-item">
        <input type="checkbox" id="check8"> Bot√≥n "+" presente en cada card
      </div>
      <div class="checklist-item">
        <input type="checkbox" id="check9"> Click en producto abre modal
      </div>
      <div class="checklist-item">
        <input type="checkbox" id="check10"> Agregar al carrito funciona
      </div>
      <div class="checklist-item">
        <input type="checkbox" id="check11"> IDs de secciones correctos (#pescado, #mariscos, etc.)
      </div>
      <div class="checklist-item">
        <input type="checkbox" id="check12"> Scroll a categor√≠as funciona
      </div>
    </div>
    
    <!-- Secci√≥n de Cat√°logo -->
    <section class="catalogo py-5" style="background: white; border-radius: 10px;">
      <div class="container">
        <h2 class="text-center mb-5">Cat√°logo Completo</h2>
        
        <!-- Contenedor de secciones (se inyecta din√°micamente) -->
        <div id="catalogo-sections-container">
          <!-- Las secciones de categor√≠as se generan con JavaScript -->
        </div>
      </div>
    </section>
    
    <!-- Modal de Producto (mismo que Componente 5) -->
    <div class="modal fade" id="productoModal" tabindex="-1" aria-labelledby="modalProductTitle" aria-hidden="true">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalProductTitle">Producto</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col-md-6">
                <img id="modalProductImage" src="" class="img-fluid rounded" alt="Producto">
              </div>
              <div class="col-md-6">
                <p id="modalProductDescription" class="mb-3">Descripci√≥n del producto</p>
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h4 class="text-success mb-0" id="modalProductPrice">$0</h4>
                  <small class="text-muted" id="modalProductStock">Stock: 0</small>
                </div>
                <div class="input-group mb-3" style="max-width: 200px;">
                  <button class="btn btn-outline-secondary" type="button" id="modalQuantityMinus">-</button>
                  <input type="number" class="form-control text-center" id="modalQuantity" value="1" min="1">
                  <button class="btn btn-outline-secondary" type="button" id="modalQuantityPlus">+</button>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <span>Total:</span>
                  <h4 class="text-primary mb-0" id="modalTotal">$0</h4>
                </div>
                <button type="button" class="btn btn-primary w-100" id="modalAddToCart">
                  <i class="bi bi-cart-plus me-2"></i>
                  Agregar al Carrito
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Offcanvas del Carrito -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="carritoOffcanvas">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title">
          <i class="bi bi-cart3 me-2"></i>
          Mi Carrito
          <span class="badge bg-primary ms-2" id="cart-badge">0</span>
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
      </div>
      <div class="offcanvas-body">
        <div id="cart-items-list">
          <p class="text-center text-muted">El carrito est√° vac√≠o</p>
        </div>
        <div class="mt-auto pt-3 border-top">
          <div class="d-flex justify-content-between mb-3">
            <strong>Total:</strong>
            <strong id="cart-total">$0</strong>
          </div>
          <button class="btn btn-primary w-100">Ir a Pagar</button>
        </div>
      </div>
    </div>
    
    <!-- Bot√≥n flotante del carrito -->
    <button class="btn btn-primary position-fixed bottom-0 end-0 m-4 rounded-circle shadow-lg" 
            style="width: 60px; height: 60px; z-index: 1000;"
            data-bs-toggle="offcanvas" 
            data-bs-target="#carritoOffcanvas">
      <i class="bi bi-cart3 fs-4"></i>
      <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" 
            id="cart-badge-float">
        0
      </span>
    </button>
    
    <!-- Logs de Consola -->
    <div class="checklist mt-4">
      <h4>üìã Logs de Consola</h4>
      <div id="console-logs" class="code-block">
        <div class="text-muted">Los logs aparecer√°n aqu√≠...</div>
      </div>
    </div>
    
  </div>
  
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  
  <!-- Bootstrap 5 JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- CONFIG -->
  <script>
    const CONFIG = {
      BASE_PATH: '/MARAZUL/MARAZUL/frontend',
      API_URL: 'http://localhost:5000/api',
      DEFAULT_IMAGE: 'https://via.placeholder.com/400x300?text=Sin+Imagen',
      isProduction: false
    };
    
    const STORAGE_KEYS = {
      CART: 'marazul_cart',
      CART_COUNT: 'marazul_cart_count'
    };
  </script>
  
  <!-- UTILS -->
  <script>
    function formatPrice(price) {
      return '$' + price.toLocaleString('es-CL');
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function getAuthToken() {
      return localStorage.getItem('marazul_token');
    }
    
    // Logger personalizado
    const originalLog = console.log;
    const originalError = console.error;
    
    function addLogToPage(message, type = 'log') {
      const logsContainer = document.getElementById('console-logs');
      const timestamp = new Date().toLocaleTimeString();
      const color = type === 'error' ? 'text-danger' : 'text-success';
      
      const logEntry = document.createElement('div');
      logEntry.className = color;
      logEntry.innerHTML = `[${timestamp}] ${message}`;
      
      logsContainer.appendChild(logEntry);
      logsContainer.scrollTop = logsContainer.scrollHeight;
    }
    
    console.log = function(...args) {
      originalLog.apply(console, args);
      addLogToPage(args.join(' '), 'log');
    };
    
    console.error = function(...args) {
      originalError.apply(console, args);
      addLogToPage(args.join(' '), 'error');
    };
  </script>
  
  <!-- API CLIENT -->
  <script>
    async function apiRequest(method, endpoint, data = null) {
      try {
        const url = CONFIG.API_URL + endpoint;
        const token = getAuthToken();
        
        const headers = {
          'Content-Type': 'application/json'
        };
        
        if (token) {
          headers['Authorization'] = `Bearer ${token}`;
        }
        
        const ajaxConfig = {
          url: url,
          method: method.toUpperCase(),
          headers: headers,
          dataType: 'json',
          timeout: 30000
        };
        
        if (data && (method.toUpperCase() === 'POST' || method.toUpperCase() === 'PUT')) {
          ajaxConfig.data = JSON.stringify(data);
        }
        
        console.log('üåê API Request:', method, endpoint);
        
        const response = await $.ajax(ajaxConfig);
        
        console.log('‚úÖ API Response:', response);
        
        return {
          success: response.success !== false,
          data: response.data || response.Datos || response.datos || [],
          pagination: response.pagination || null,
          error: null
        };
        
      } catch (error) {
        console.error('‚ùå Error en API:', error);
        return {
          success: false,
          data: [],
          error: {
            message: error.responseJSON?.message || error.statusText || 'Error de conexi√≥n',
            status: error.status
          }
        };
      }
    }
    
    async function getProducts(filters = {}) {
      let endpoint = '/products';
      
      const params = new URLSearchParams();
      
      if (filters.category) {
        params.append('category', filters.category);
      }
      
      if (filters.categoryId) {
        params.append('categoryId', filters.categoryId);
      }
      
      if (filters.limit) {
        params.append('limit', filters.limit);
      }
      
      if (params.toString()) {
        endpoint += '?' + params.toString();
      }
      
      return await apiRequest('GET', endpoint);
    }
    
    async function getProductsByCategory(category, limit = null) {
      const filters = { category: category };
      if (limit) filters.limit = limit;
      return await getProducts(filters);
    }
    
    async function getCategories() {
      return await apiRequest('GET', '/categories');
    }
    
    async function checkBackendHealth() {
      const statusDiv = document.getElementById('backend-status');
      
      try {
        const response = await fetch(CONFIG.API_URL.replace('/api', '') + '/health', {
          method: 'GET',
          timeout: 5000
        });
        
        if (response.ok) {
          statusDiv.innerHTML = `
            <span class="status-badge status-success">
              ‚úÖ Backend disponible
            </span>
            <p class="mt-2 mb-0">Conectado a: ${CONFIG.API_URL}</p>
          `;
        } else {
          throw new Error('Backend responde pero con error');
        }
      } catch (error) {
        statusDiv.innerHTML = `
          <span class="status-badge status-error">
            ‚ùå Backend no disponible
          </span>
          <p class="mt-2 mb-0 text-danger">
            Aseg√∫rate de ejecutar: <code>cd backend && npm run dev</code>
          </p>
        `;
      }
    }
  </script>
  
  <!-- CART -->
  <script>
    function getCart() {
      const cart = localStorage.getItem(STORAGE_KEYS.CART);
      return cart ? JSON.parse(cart) : { items: [], total: 0 };
    }
    
    function saveCart(cart) {
      localStorage.setItem(STORAGE_KEYS.CART, JSON.stringify(cart));
      localStorage.setItem(STORAGE_KEYS.CART_COUNT, cart.items.length);
      updateCartBadge();
    }
    
    function addToCart(product, quantity = 1) {
      const cart = getCart();
      
      const existingItem = cart.items.find(item => item.id === product.id);
      
      if (existingItem) {
        existingItem.quantity += quantity;
      } else {
        cart.items.push({
          id: product.id,
          title: product.title,
          price: product.price,
          img: product.img,
          quantity: quantity
        });
      }
      
      cart.total = cart.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      
      saveCart(cart);
      
      console.log(`‚úÖ Producto agregado: ${product.title} x${quantity}`);
    }
    
    function updateCartBadge() {
      const cart = getCart();
      const count = cart.items.length;
      
      $('#cart-badge').text(count);
      $('#cart-badge-float').text(count);
      
      if (count === 0) {
        $('#cart-items-list').html('<p class="text-center text-muted">El carrito est√° vac√≠o</p>');
        $('#cart-total').text('$0');
      } else {
        let html = '';
        cart.items.forEach(item => {
          html += `
            <div class="mb-3 pb-3 border-bottom">
              <h6>${item.title}</h6>
              <p class="mb-0">Cantidad: ${item.quantity} x ${formatPrice(item.price)}</p>
            </div>
          `;
        });
        $('#cart-items-list').html(html);
        $('#cart-total').text(formatPrice(cart.total));
      }
    }
  </script>
  
  <!-- CAT√ÅLOGO (index.js) -->
  <script src="js/pages/index.js"></script>
  
  <!-- Inicializaci√≥n -->
  <script>
    $(document).ready(function() {
      console.log('üß™ Iniciando test del Componente 6...');
      
      checkBackendHealth();
      updateCartBadge();
      
      console.log('‚úÖ Test inicializado. Esperando carga del cat√°logo...');
    });
  </script>
  
</body>
</html>