<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MarAzul - Test API Client</title>
  
  <!-- Bootstrap 5.3 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  
  <style>
    .status-online { color: #28a745; }
    .status-offline { color: #dc3545; }
    .test-result { font-family: 'Courier New', monospace; font-size: 0.85rem; }
  </style>
</head>
<body class="bg-light">
  
  <!-- Header -->
  <header class="bg-primary text-white py-3 mb-4">
    <div class="container">
      <h5 class="mb-0">
        <i class="bi bi-cloud me-2"></i>
        MarAzul - Test API Client
      </h5>
      <p class="mb-0 small">Pruebas de conectividad con backend Node.js/Express/MongoDB</p>
    </div>
  </header>
  
  <div class="container py-4">
    
    <!-- Status General -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card shadow-sm">
          <div class="card-body">
            <h5 class="card-title">
              <i class="bi bi-plug text-success me-2"></i>
              Estado de ConexiÃ³n
            </h5>
            <div id="api-status" class="mt-3">
              <div class="spinner-border spinner-border-sm" role="status">
                <span class="visually-hidden">Verificando...</span>
              </div>
              Verificando conexiÃ³n con backend...
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Backend Info -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card shadow-sm">
          <div class="card-header bg-info text-white">
            <h6 class="mb-0">
              <i class="bi bi-server me-2"></i>
              ConfiguraciÃ³n del Backend
            </h6>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-sm mb-0">
                <tbody>
                  <tr>
                    <th style="width: 200px;">API URL</th>
                    <td id="info-api-url">...</td>
                  </tr>
                  <tr>
                    <th>Entorno</th>
                    <td id="info-environment">...</td>
                  </tr>
                  <tr>
                    <th>Estado Backend</th>
                    <td id="info-backend-status">...</td>
                  </tr>
                  <tr>
                    <th>Funciones API</th>
                    <td id="info-functions">...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Tests de Endpoints -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card shadow-sm">
          <div class="card-header bg-success text-white">
            <h6 class="mb-0">
              <i class="bi bi-list-check me-2"></i>
              Tests de Endpoints
            </h6>
          </div>
          <div class="card-body">
            <p class="text-muted small mb-3">
              <strong>IMPORTANTE:</strong> Estos tests requieren que el backend estÃ© corriendo en 
              <code>http://localhost:5000</code>
            </p>
            
            <!-- Test 1: Backend Health -->
            <div class="mb-3 pb-3 border-bottom">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">1. Backend Health Check</h6>
                <button class="btn btn-sm btn-outline-primary" onclick="testBackendHealth()">
                  <i class="bi bi-arrow-repeat me-1"></i>
                  Probar
                </button>
              </div>
              <div id="result-health" class="test-result text-muted">
                Haz clic en "Probar" para verificar conectividad
              </div>
            </div>
            
            <!-- Test 2: Get Products -->
            <div class="mb-3 pb-3 border-bottom">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">2. GET /api/products (Todos los productos)</h6>
                <button class="btn btn-sm btn-outline-primary" onclick="testGetProducts()">
                  <i class="bi bi-arrow-repeat me-1"></i>
                  Probar
                </button>
              </div>
              <div id="result-products" class="test-result text-muted">
                Haz clic en "Probar"
              </div>
            </div>
            
            <!-- Test 3: Get Featured Products -->
            <div class="mb-3 pb-3 border-bottom">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">3. GET /api/products?featured=true (Destacados)</h6>
                <button class="btn btn-sm btn-outline-primary" onclick="testGetFeatured()">
                  <i class="bi bi-arrow-repeat me-1"></i>
                  Probar
                </button>
              </div>
              <div id="result-featured" class="test-result text-muted">
                Haz clic en "Probar"
              </div>
            </div>
            
            <!-- Test 4: Get Categories -->
            <div class="mb-3 pb-3 border-bottom">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">4. GET /api/categories (CategorÃ­as activas)</h6>
                <button class="btn btn-sm btn-outline-primary" onclick="testGetCategories()">
                  <i class="bi bi-arrow-repeat me-1"></i>
                  Probar
                </button>
              </div>
              <div id="result-categories" class="test-result text-muted">
                Haz clic en "Probar"
              </div>
            </div>
            
            <!-- Test 5: Search Products -->
            <div class="mb-3 pb-3 border-bottom">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">5. GET /api/products?search=... (BÃºsqueda)</h6>
                <div class="d-flex gap-2">
                  <input type="text" id="search-query" class="form-control form-control-sm" 
                         placeholder="TÃ©rmino de bÃºsqueda" value="salmÃ³n" style="width: 200px;">
                  <button class="btn btn-sm btn-outline-primary" onclick="testSearchProducts()">
                    <i class="bi bi-search me-1"></i>
                    Buscar
                  </button>
                </div>
              </div>
              <div id="result-search" class="test-result text-muted">
                Ingresa un tÃ©rmino y haz clic en "Buscar"
              </div>
            </div>
            
            <!-- Test 6: Login (Simulado) -->
            <div class="mb-3">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">6. POST /api/auth/login (Login)</h6>
                <button class="btn btn-sm btn-outline-warning" onclick="testLogin()">
                  <i class="bi bi-box-arrow-in-right me-1"></i>
                  Test Login
                </button>
              </div>
              <p class="small text-muted mb-2">
                <strong>Nota:</strong> Este test intentarÃ¡ hacer login con credenciales de prueba.
                Si no tienes un usuario registrado, el test fallarÃ¡ (comportamiento esperado).
              </p>
              <div id="result-login" class="test-result text-muted">
                Haz clic en "Test Login" (puede fallar si no hay usuario)
              </div>
            </div>
            
          </div>
        </div>
      </div>
    </div>
    
    <!-- Checklist -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="alert alert-light border" role="alert">
          <h5 class="alert-heading">
            <i class="bi bi-clipboard-check me-2"></i>
            Checklist de VerificaciÃ³n
          </h5>
          <div id="checklist">
            <div class="spinner-border spinner-border-sm" role="status">
              <span class="visually-hidden">Cargando...</span>
            </div>
            Ejecutando tests...
          </div>
        </div>
      </div>
    </div>
    
    <!-- Instrucciones -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="alert alert-info">
          <h6 class="alert-heading">
            <i class="bi bi-info-circle me-2"></i>
            Â¿CÃ³mo usar esta pÃ¡gina de tests?
          </h6>
          <ol class="mb-0 small">
            <li><strong>Backend corriendo:</strong> AsegÃºrate de que tu backend Node.js estÃ© corriendo en <code>http://localhost:5000</code></li>
            <li><strong>Tests automÃ¡ticos:</strong> Al cargar la pÃ¡gina se verifica la conectividad automÃ¡ticamente</li>
            <li><strong>Tests manuales:</strong> Haz clic en cada botÃ³n "Probar" para testear endpoints especÃ­ficos</li>
            <li><strong>Errores esperados:</strong> Algunos tests pueden fallar si tu backend no tiene datos o rutas configuradas</li>
            <li><strong>Consola (F12):</strong> Revisa la consola del navegador para logs detallados</li>
          </ol>
        </div>
      </div>
    </div>
    
  </div>
  
  <!-- jQuery 3.7.1 (REQUERIDO) -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js" 
          integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" 
          crossorigin="anonymous"></script>
  
  <!-- Bootstrap 5.3 Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- CONFIG, UTILS, AUTH, CART y API -->
  <script src="js/config.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/cart.js"></script>
  <script src="js/api.js"></script>
  
  <!-- Tests -->
  <script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TESTS AUTOMÃTICOS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    $(document).ready(async function() {
      console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
      console.log('ğŸ§ª INICIANDO TESTS DE API CLIENT');
      console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
      
      let errores = 0;
      
      // Mostrar info bÃ¡sica
      $('#info-api-url').html(`<code>${CONFIG.API_URL}</code>`);
      $('#info-environment').html(`<span class="badge bg-${CONFIG.isProduction ? 'danger' : 'success'}">${CONFIG.isProduction ? 'PRODUCCIÃ“N' : 'DESARROLLO'}</span>`);
      
      // Test 1: Verificar que API existe
      if (typeof API !== 'undefined') {
        console.log('âœ… API estÃ¡ definido');
        $('#info-functions').html(`<span class="badge bg-success">${Object.keys(API).length} funciones</span>`);
      } else {
        console.error('âŒ API no estÃ¡ definido');
        errores++;
        $('#info-functions').html(`<span class="badge bg-danger">ERROR</span>`);
      }
      
      // Test 2: Verificar conectividad con backend
      $('#api-status').html(`
        <div class="d-flex align-items-center">
          <div class="spinner-border spinner-border-sm me-2" role="status"></div>
          <span>Verificando backend en ${CONFIG.API_URL}...</span>
        </div>
      `);
      
      const isBackendOnline = await checkBackendHealth();
      
      if (isBackendOnline) {
        $('#api-status').html(`
          <div class="alert alert-success mb-0">
            <i class="bi bi-check-circle-fill me-2"></i>
            <strong>Backend disponible!</strong> Conectado exitosamente a ${CONFIG.API_URL}
          </div>
        `);
        $('#info-backend-status').html('<span class="status-online"><i class="bi bi-circle-fill me-1"></i>ONLINE</span>');
        console.log('âœ… Backend disponible');
      } else {
        $('#api-status').html(`
          <div class="alert alert-warning mb-0">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <strong>Backend no disponible</strong><br>
            <small>AsegÃºrate de que el backend estÃ© corriendo en ${CONFIG.API_URL}</small><br>
            <small class="text-muted">Los tests de endpoints fallarÃ¡n, pero el mÃ³dulo API estÃ¡ correctamente cargado.</small>
          </div>
        `);
        $('#info-backend-status').html('<span class="status-offline"><i class="bi bi-circle-fill me-1"></i>OFFLINE</span>');
        console.warn('âš ï¸  Backend no disponible');
      }
      
      // Checklist
      setTimeout(() => {
        const checks = [
          { name: 'API.js cargado', status: typeof API !== 'undefined' },
          { name: 'apiRequest() disponible', status: typeof apiRequest === 'function' },
          { name: 'login() disponible', status: typeof login === 'function' },
          { name: 'register() disponible', status: typeof register === 'function' },
          { name: 'getProducts() disponible', status: typeof getProducts === 'function' },
          { name: 'getFeaturedProducts() disponible', status: typeof getFeaturedProducts === 'function' },
          { name: 'getProductsByCategory() disponible', status: typeof getProductsByCategory === 'function' },
          { name: 'searchProducts() disponible', status: typeof searchProducts === 'function' },
          { name: 'getCategories() disponible', status: typeof getCategories === 'function' },
          { name: 'syncCart() disponible', status: typeof syncCart === 'function' },
          { name: 'createOrder() disponible', status: typeof createOrder === 'function' },
          { name: 'checkBackendHealth() disponible', status: typeof checkBackendHealth === 'function' },
        ];
        
        let checklistHTML = '<ul class="list-unstyled mb-0">';
        checks.forEach(check => {
          const icon = check.status ? 'âœ…' : 'âŒ';
          const className = check.status ? 'text-success' : 'text-danger';
          checklistHTML += `<li class="${className}"><strong>${icon}</strong> ${check.name}</li>`;
          if (!check.status) errores++;
        });
        checklistHTML += '</ul>';
        
        if (errores === 0) {
          checklistHTML += `
            <div class="alert alert-success mt-3 mb-0">
              <strong>Â¡Todos los mÃ³dulos cargados!</strong> API client estÃ¡ listo.
              ${isBackendOnline ? '' : '<br><small class="text-warning">âš ï¸  Nota: Backend no disponible para tests de endpoints.</small>'}
            </div>
          `;
        } else {
          checklistHTML += `<div class="alert alert-danger mt-3 mb-0"><strong>Errores detectados:</strong> ${errores} error(es)</div>`;
        }
        
        $('#checklist').html(checklistHTML);
      }, 1000);
      
      console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    });
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TESTS MANUALES DE ENDPOINTS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    async function testBackendHealth() {
      $('#result-health').html('<div class="spinner-border spinner-border-sm me-2"></div>Verificando...');
      
      const isOnline = await checkBackendHealth();
      
      if (isOnline) {
        $('#result-health').html(`
          <div class="text-success">
            <i class="bi bi-check-circle-fill me-2"></i>
            <strong>âœ… Backend disponible</strong>
            <div class="small mt-1">Conectado a ${CONFIG.API_URL}</div>
          </div>
        `);
      } else {
        $('#result-health').html(`
          <div class="text-danger">
            <i class="bi bi-x-circle-fill me-2"></i>
            <strong>âŒ Backend no disponible</strong>
            <div class="small mt-1">Verifica que estÃ© corriendo en ${CONFIG.API_URL}</div>
          </div>
        `);
      }
    }
    
    async function testGetProducts() {
      $('#result-products').html('<div class="spinner-border spinner-border-sm me-2"></div>Cargando...');
      
      const result = await getProducts();
      
      if (result.success) {
        const products = result.data;
        $('#result-products').html(`
          <div class="text-success">
            <i class="bi bi-check-circle-fill me-2"></i>
            <strong>âœ… ${products.length} productos obtenidos</strong>
            <details class="mt-2">
              <summary class="small text-primary" style="cursor: pointer;">Ver primeros 3 productos</summary>
              <pre class="mt-2 mb-0 small bg-light p-2 rounded">${JSON.stringify(products.slice(0, 3), null, 2)}</pre>
            </details>
          </div>
        `);
        console.log('âœ… Productos obtenidos:', products.length);
      } else {
        $('#result-products').html(`
          <div class="text-danger">
            <i class="bi bi-x-circle-fill me-2"></i>
            <strong>âŒ Error: ${result.error.message}</strong>
            <div class="small mt-1">Status: ${result.error.statusCode || 'N/A'}</div>
          </div>
        `);
        console.error('âŒ Error obteniendo productos:', result.error);
      }
    }
    
    async function testGetFeatured() {
      $('#result-featured').html('<div class="spinner-border spinner-border-sm me-2"></div>Cargando...');
      
      const result = await getFeaturedProducts(6);
      
      if (result.success) {
        const products = result.data;
        $('#result-featured').html(`
          <div class="text-success">
            <i class="bi bi-check-circle-fill me-2"></i>
            <strong>âœ… ${products.length} productos destacados</strong>
            <div class="small mt-1">${products.map(p => p.name || p.title).join(', ')}</div>
          </div>
        `);
        console.log('âœ… Productos destacados:', products);
      } else {
        $('#result-featured').html(`
          <div class="text-danger">
            <i class="bi bi-x-circle-fill me-2"></i>
            <strong>âŒ Error: ${result.error.message}</strong>
          </div>
        `);
        console.error('âŒ Error:', result.error);
      }
    }
    
    async function testGetCategories() {
      $('#result-categories').html('<div class="spinner-border spinner-border-sm me-2"></div>Cargando...');
      
      const result = await getCategories();
      
      if (result.success) {
        const categories = result.data;
        $('#result-categories').html(`
          <div class="text-success">
            <i class="bi bi-check-circle-fill me-2"></i>
            <strong>âœ… ${categories.length} categorÃ­as activas</strong>
            <div class="small mt-1">${categories.map(c => c.name).join(', ')}</div>
          </div>
        `);
        console.log('âœ… CategorÃ­as:', categories);
      } else {
        $('#result-categories').html(`
          <div class="text-danger">
            <i class="bi bi-x-circle-fill me-2"></i>
            <strong>âŒ Error: ${result.error.message}</strong>
          </div>
        `);
        console.error('âŒ Error:', result.error);
      }
    }
    
    async function testSearchProducts() {
      const query = $('#search-query').val();
      
      if (!query) {
        alert('Ingresa un tÃ©rmino de bÃºsqueda');
        return;
      }
      
      $('#result-search').html(`<div class="spinner-border spinner-border-sm me-2"></div>Buscando "${query}"...`);
      
      const result = await searchProducts(query);
      
      if (result.success) {
        const products = result.data;
        $('#result-search').html(`
          <div class="text-success">
            <i class="bi bi-check-circle-fill me-2"></i>
            <strong>âœ… ${products.length} resultados para "${query}"</strong>
            ${products.length > 0 ? `<div class="small mt-1">${products.map(p => p.name || p.title).slice(0, 5).join(', ')}</div>` : ''}
          </div>
        `);
        console.log('âœ… BÃºsqueda:', products);
      } else {
        $('#result-search').html(`
          <div class="text-danger">
            <i class="bi bi-x-circle-fill me-2"></i>
            <strong>âŒ Error: ${result.error.message}</strong>
          </div>
        `);
        console.error('âŒ Error:', result.error);
      }
    }
    
    async function testLogin() {
      $('#result-login').html('<div class="spinner-border spinner-border-sm me-2"></div>Intentando login...');
      
      // Credenciales de prueba
      const result = await login('test@marazul.com', 'Password123');
      
      if (result.success) {
        $('#result-login').html(`
          <div class="text-success">
            <i class="bi bi-check-circle-fill me-2"></i>
            <strong>âœ… Login exitoso!</strong>
            <div class="small mt-1">Usuario: ${result.data.user.name || result.data.user.email}</div>
            <div class="small">Token: ${result.data.token.substring(0, 30)}...</div>
          </div>
        `);
        console.log('âœ… Login exitoso:', result.data);
      } else {
        $('#result-login').html(`
          <div class="text-warning">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <strong>âš ï¸  ${result.error.message}</strong>
            <div class="small mt-1">Esto es esperado si no tienes un usuario "test@marazul.com" registrado</div>
          </div>
        `);
        console.warn('âš ï¸  Login fallÃ³ (esperado):', result.error);
      }
    }
  </script>
  
</body>
</html>