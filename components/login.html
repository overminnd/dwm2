<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Iniciar sesión — MarAzul</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Ajusta la ruta BASE si tu proyecto no está en /MARAZUL/MARAZUL -->
  <!-- CSS del proyecto (ruta absoluta según tu servidor) -->
  <link rel="stylesheet" href="/MARAZUL/MARAZUL/css/style.css">
  <style>
    /* pequeños estilos de soporte para la demo */
    .card-login { max-width: 420px; margin: 40px auto; }
    .small-muted { font-size: .9rem; color: #6c757d; }
  </style>
</head>
<body>

  <!-- header inyectado -->
  <div id="header-container"></div>

  <main class="container">
    <div class="card card-login shadow-sm">
      <div class="card-body">
        <h5 class="card-title text-center mb-4">Iniciar sesión</h5>

        <!-- STEP 1: Email -->
        <form id="emailForm">
          <div class="mb-3">
            <label for="emailInput" class="form-label">Email</label>
            <input id="emailInput" type="email" class="form-control" placeholder="tucorreo@ejemplo.com" required>
            <div id="emailError" class="invalid-feedback d-none"></div>
          </div>
          <button id="emailContinueBtn" class="btn btn-primary w-100" type="submit">Continuar</button>
        </form>

        <!-- STEP 2: Password (hidden by default) -->
        <form id="passwordForm" class="d-none mt-3">
          <div class="mb-3">
            <label for="passwordInput" class="form-label">Contraseña</label>
            <input id="passwordInput" type="password" class="form-control" placeholder="Ingresa tu contraseña" required>
            <div id="passwordError" class="invalid-feedback d-none"></div>
          </div>
          <div class="d-flex gap-2">
            <button id="loginBtn" class="btn btn-success flex-grow-1" type="submit">Iniciar sesión</button>
            <button id="backToEmail" class="btn btn-outline-secondary" type="button">Volver</button>
          </div>
        </form>

        <hr class="my-3">
        <div class="text-center small-muted">
          ¿No tienes cuenta? <a id="toRegister" href="/MARAZUL/MARAZUL/components/registro.html">Crear cuenta</a>
        </div>
      </div>
    </div>
  </main>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/MARAZUL/MARAZUL/js/header.js"></script>
  <script>
  // BASE: ajusta si tu proyecto no está en /MARAZUL/MARAZUL
  const BASE = '/MARAZUL/MARAZUL';

  // Simple loader para header (usa ruta absoluta para evitar problemas)
  function loadComponent(containerId, filePath, callback) {
    fetch(filePath)
      .then(res => {
        if (!res.ok) throw new Error("HTTP " + res.status);
        return res.text();
      })
      .then(html => {
        document.getElementById(containerId).innerHTML = html;
        if (typeof callback === "function") callback();
      })
      .catch(err => console.error("Error al cargar " + filePath, err));
  }

  // carga header
  loadComponent("header-container", BASE + "/components/header.html", () => {
    if (typeof initHeader === 'function') initHeader();
  });

  // Simulación de base de datos en localStorage
  function getUsers() {
    return JSON.parse(localStorage.getItem('marazul_users') || '[]');
  }
  function saveUsers(users) {
    localStorage.setItem('marazul_users', JSON.stringify(users));
  }

  // OPCIONAL: usuario demo para que pruebes
  (function ensureDemoUser(){
    const users = getUsers();
    if (!users.find(u => u.email === 'demo@marazul.test')) {
      users.push({ email: 'demo@marazul.test', password: 'demo123', name: 'Usuario Demo' });
      saveUsers(users);
    }
  })();

  document.addEventListener('DOMContentLoaded', () => {
    const emailForm = document.getElementById('emailForm');
    const passwordForm = document.getElementById('passwordForm');
    const emailInput = document.getElementById('emailInput');
    const passwordInput = document.getElementById('passwordInput');
    const emailError = document.getElementById('emailError');
    const passwordError = document.getElementById('passwordError');
    const emailContinueBtn = document.getElementById('emailContinueBtn');
    const loginBtn = document.getElementById('loginBtn');
    const backToEmail = document.getElementById('backToEmail');

    let currentUser = null; // usuario encontrado tras comprobar email

    emailForm.addEventListener('submit', (ev) => {
      ev.preventDefault();
      emailError.classList.add('d-none');
      const email = emailInput.value.trim().toLowerCase();
      if (!email) {
        emailError.textContent = 'Ingresa un correo válido.';
        emailError.classList.remove('d-none');
        return;
      }

      const users = getUsers();
      const found = users.find(u => u.email.toLowerCase() === email);
      if (found) {
        // existe: mostrar paso de contraseña
        currentUser = found;
        emailForm.classList.add('d-none');
        passwordForm.classList.remove('d-none');
        passwordInput.focus();
      } else {
        // no existe: redirigir a registro (prellenar email)
        const target = BASE + '/components/registro.html?email=' + encodeURIComponent(email);
        window.location.href = target;
      }
    });

    passwordForm.addEventListener('submit', (ev) => {
      ev.preventDefault();
      passwordError.classList.add('d-none');
      const pw = passwordInput.value || '';
      if (!currentUser) {
        passwordError.textContent = 'Error interno: usuario no definido.';
        passwordError.classList.remove('d-none');
        return;
      }
      if (pw === currentUser.password) {
        // login simulado: guardar "sesión"
        localStorage.setItem('marazul_current_user', JSON.stringify({
          email: currentUser.email,
          name: currentUser.name || ''
        }));
        alert('Login correcto. Bienvenido ' + (currentUser.name || currentUser.email));
        // redirigir al index
        window.location.href = '../index.html';
      } else {
        passwordError.textContent = 'Contraseña incorrecta. Intenta de nuevo.';
        passwordError.classList.remove('d-none');
      }
    });

    backToEmail.addEventListener('click', () => {
      passwordForm.classList.add('d-none');
      emailForm.classList.remove('d-none');
      passwordInput.value = '';
    });
  });
  </script>
</body>
</html>
