<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DEBUG - Test Login Flow</title>
  
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  
  <style>
    body { background: #1a1a2e; color: #eee; font-family: monospace; padding: 20px; }
    .log-success { color: #4ade80; }
    .log-error { color: #f87171; }
    .log-warning { color: #fbbf24; }
    .log-info { color: #60a5fa; }
    .test-card { background: #16213e; border-radius: 10px; padding: 20px; margin-bottom: 20px; }
    .code-block { background: #0f0f23; padding: 15px; border-radius: 8px; font-size: 12px; overflow-x: auto; }
    pre { margin: 0; white-space: pre-wrap; }
    .btn-test { min-width: 200px; }
  </style>
</head>
<body>

<div class="container-fluid">
  <h1 class="mb-4"><i class="bi bi-bug"></i> DEBUG: Flujo de Login MarAzul</h1>
  
  <div class="row">
    <!-- Panel de Tests -->
    <div class="col-md-6">
      <div class="test-card">
        <h4><i class="bi bi-1-circle-fill me-2"></i>Test 1: Verificar Dependencias</h4>
        <p class="text-muted">Verifica que todos los scripts necesarios estén cargados</p>
        <button class="btn btn-primary btn-test" onclick="test1_Dependencies()">
          <i class="bi bi-play-fill me-2"></i>Ejecutar Test 1
        </button>
        <div id="result1" class="mt-3"></div>
      </div>
      
      <div class="test-card">
        <h4><i class="bi bi-2-circle-fill me-2"></i>Test 2: Verificar apiRequest Signature</h4>
        <p class="text-muted">Verifica cómo se llama apiRequest y qué recibe</p>
        <button class="btn btn-primary btn-test" onclick="test2_ApiRequestSignature()">
          <i class="bi bi-play-fill me-2"></i>Ejecutar Test 2
        </button>
        <div id="result2" class="mt-3"></div>
      </div>
      
      <div class="test-card">
        <h4><i class="bi bi-3-circle-fill me-2"></i>Test 3: Login Real al Backend</h4>
        <p class="text-muted">Intenta hacer login real y muestra toda la respuesta</p>
        <div class="mb-3">
          <input type="email" id="testEmail" class="form-control mb-2" placeholder="Email" value="admin@marazul.com">
          <input type="password" id="testPassword" class="form-control" placeholder="Password" value="Admin123">
        </div>
        <button class="btn btn-success btn-test" onclick="test3_RealLogin()">
          <i class="bi bi-box-arrow-in-right me-2"></i>Ejecutar Login Real
        </button>
        <div id="result3" class="mt-3"></div>
      </div>
      
      <div class="test-card">
        <h4><i class="bi bi-4-circle-fill me-2"></i>Test 4: Verificar localStorage</h4>
        <p class="text-muted">Muestra el estado actual del localStorage</p>
        <button class="btn btn-info btn-test" onclick="test4_LocalStorage()">
          <i class="bi bi-database me-2"></i>Ver localStorage
        </button>
        <button class="btn btn-danger btn-sm ms-2" onclick="clearAllStorage()">
          <i class="bi bi-trash me-2"></i>Limpiar Todo
        </button>
        <div id="result4" class="mt-3"></div>
      </div>
      
      <div class="test-card">
        <h4><i class="bi bi-5-circle-fill me-2"></i>Test 5: Simular Flujo Completo</h4>
        <p class="text-muted">Simula login + guarda en localStorage + verifica initHeader</p>
        <button class="btn btn-warning btn-test" onclick="test5_FullFlow()">
          <i class="bi bi-lightning-fill me-2"></i>Simular Flujo Completo
        </button>
        <div id="result5" class="mt-3"></div>
      </div>
    </div>
    
    <!-- Panel de Logs -->
    <div class="col-md-6">
      <div class="test-card" style="position: sticky; top: 20px;">
        <h4><i class="bi bi-terminal me-2"></i>Console Log</h4>
        <button class="btn btn-outline-light btn-sm mb-3" onclick="clearLogs()">
          <i class="bi bi-trash me-2"></i>Limpiar Logs
        </button>
        <div id="logOutput" class="code-block" style="height: 600px; overflow-y: auto;">
          <pre id="logPre">Esperando tests...</pre>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Módulos de MarAzul -->
<script src="js/config.js"></script>
<script src="js/utils.js"></script>
<script src="js/auth.js"></script>
<script src="js/api.js"></script>

<script>
// ═══════════════════════════════════════════════════════════════════════════
// UTILIDADES DE LOG
// ═══════════════════════════════════════════════════════════════════════════

function log(message, type = 'info') {
  const time = new Date().toLocaleTimeString();
  const $pre = $('#logPre');
  const colorClass = `log-${type}`;
  const icon = {
    'success': '✅',
    'error': '❌',
    'warning': '⚠️',
    'info': 'ℹ️'
  }[type] || 'ℹ️';
  
  $pre.append(`\n<span class="${colorClass}">[${time}] ${icon} ${message}</span>`);
  
  // Auto-scroll
  const logDiv = document.getElementById('logOutput');
  logDiv.scrollTop = logDiv.scrollHeight;
}

function logObject(label, obj) {
  log(`${label}:`, 'info');
  const $pre = $('#logPre');
  $pre.append(`\n<span class="text-white">${JSON.stringify(obj, null, 2)}</span>`);
}

function clearLogs() {
  $('#logPre').html('Logs limpiados...');
}

// ═══════════════════════════════════════════════════════════════════════════
// TEST 1: VERIFICAR DEPENDENCIAS
// ═══════════════════════════════════════════════════════════════════════════

function test1_Dependencies() {
  log('═══ TEST 1: Verificando Dependencias ═══', 'info');
  
  const dependencies = [
    { name: 'jQuery ($)', check: typeof $ !== 'undefined' },
    { name: 'CONFIG', check: typeof CONFIG !== 'undefined' },
    { name: 'CONFIG.API_URL', check: typeof CONFIG?.API_URL !== 'undefined' },
    { name: 'UTILS', check: typeof UTILS !== 'undefined' },
    { name: 'UTILS.loadComponent', check: typeof UTILS?.loadComponent === 'function' },
    { name: 'apiRequest', check: typeof apiRequest === 'function' },
    { name: 'login (auth.js)', check: typeof login === 'function' },
    { name: 'getCurrentUser', check: typeof getCurrentUser === 'function' },
    { name: 'setCurrentUser', check: typeof setCurrentUser === 'function' },
    { name: 'getAuthToken', check: typeof getAuthToken === 'function' },
    { name: 'setAuthToken', check: typeof setAuthToken === 'function' },
    { name: 'isAuthenticated', check: typeof isAuthenticated === 'function' },
    { name: 'initHeader', check: typeof initHeader === 'function' },
    { name: 'navigateTo', check: typeof navigateTo === 'function' },
    { name: 'escapeHtml', check: typeof escapeHtml === 'function' },
  ];
  
  let passed = 0;
  let failed = 0;
  
  dependencies.forEach(dep => {
    if (dep.check) {
      log(`  ${dep.name}: OK`, 'success');
      passed++;
    } else {
      log(`  ${dep.name}: NO ENCONTRADO`, 'error');
      failed++;
    }
  });
  
  log(`Resultado: ${passed} OK, ${failed} FALLIDOS`, failed > 0 ? 'warning' : 'success');
  
  // Mostrar resultado en panel
  $('#result1').html(`
    <div class="alert alert-${failed > 0 ? 'warning' : 'success'}">
      <strong>${passed}/${dependencies.length}</strong> dependencias encontradas
      ${failed > 0 ? `<br><span class="text-danger">${failed} dependencias faltantes - ver logs</span>` : ''}
    </div>
  `);
}

// ═══════════════════════════════════════════════════════════════════════════
// TEST 2: VERIFICAR FIRMA DE apiRequest
// ═══════════════════════════════════════════════════════════════════════════

function test2_ApiRequestSignature() {
  log('═══ TEST 2: Verificando apiRequest ═══', 'info');
  
  // Obtener el código fuente de apiRequest
  const fnStr = apiRequest.toString();
  
  // Extraer los parámetros
  const paramsMatch = fnStr.match(/async function apiRequest$$(.*?)$$/);
  const params = paramsMatch ? paramsMatch[1] : 'No encontrado';
  
  log(`Firma de apiRequest: apiRequest(${params})`, 'info');
  
  // Verificar cómo se llama en login.js (lo que debería ser)
  log('', 'info');
  log('PROBLEMA DETECTADO en login.js:', 'warning');
  log('  login.js llama: apiRequest("/auth/login", { method: "POST", body: {...} })', 'error');
  log('  Pero apiRequest espera: apiRequest(method, endpoint, data, options)', 'error');
  log('', 'info');
  log('SOLUCIÓN:', 'success');
  log('  Cambiar a: apiRequest("POST", "/auth/login", { email, password })', 'success');
  
  $('#result2').html(`
    <div class="alert alert-danger">
      <strong>PROBLEMA:</strong> La firma de apiRequest no coincide con cómo se llama en login.js
      <br><br>
      <strong>login.js usa:</strong><br>
      <code>apiRequest('/auth/login', { method: 'POST', body: { email, password } })</code>
      <br><br>
      <strong>apiRequest espera:</strong><br>
      <code>apiRequest(method, endpoint, data, options)</code>
    </div>
  `);
}

// ═══════════════════════════════════════════════════════════════════════════
// TEST 3: LOGIN REAL AL BACKEND
// ═══════════════════════════════════════════════════════════════════════════

async function test3_RealLogin() {
  log('═══ TEST 3: Login Real al Backend ═══', 'info');
  
  const email = $('#testEmail').val();
  const password = $('#testPassword').val();
  
  log(`Email: ${email}`, 'info');
  log(`Password: ${'*'.repeat(password.length)}`, 'info');
  log(`API URL: ${CONFIG.API_URL}`, 'info');
  
  try {
    // Método CORRECTO de llamar apiRequest
    log('Llamando apiRequest("POST", "/auth/login", {...}) - FORMA CORRECTA', 'info');
    
    const response = await fetch(`${CONFIG.API_URL}/auth/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password })
    });
    
    const data = await response.json();
    
    log(`Status HTTP: ${response.status}`, response.ok ? 'success' : 'error');
    logObject('Respuesta del Backend', data);
    
    if (data.success) {
      log('LOGIN EXITOSO!', 'success');
      log(`Token recibido: ${data.token?.substring(0, 30)}...`, 'success');
      log(`Usuario: ${data.user?.email}`, 'success');
      
      // Guardar en localStorage
      localStorage.setItem('marazul_auth_token', data.token);
      localStorage.setItem('marazul_current_user', JSON.stringify(data.user));
      localStorage.setItem('marazul_recent_login', 'true');
      
      log('Datos guardados en localStorage', 'success');
      
      $('#result3').html(`
        <div class="alert alert-success">
          <strong>LOGIN EXITOSO!</strong><br>
          Usuario: ${data.user?.email}<br>
          Token guardado: Sí
        </div>
      `);
    } else {
      log(`LOGIN FALLIDO: ${data.message}`, 'error');
      
      $('#result3').html(`
        <div class="alert alert-danger">
          <strong>LOGIN FALLIDO:</strong> ${data.message}
        </div>
      `);
    }
    
  } catch (error) {
    log(`Error de conexión: ${error.message}`, 'error');
    
    $('#result3').html(`
      <div class="alert alert-danger">
        <strong>ERROR:</strong> ${error.message}<br>
        ¿Está corriendo el backend en ${CONFIG.API_URL}?
      </div>
    `);
  }
}

// ═══════════════════════════════════════════════════════════════════════════
// TEST 4: VERIFICAR LOCALSTORAGE
// ═══════════════════════════════════════════════════════════════════════════

function test4_LocalStorage() {
  log('═══ TEST 4: Estado de localStorage ═══', 'info');
  
  const keys = [
    'marazul_auth_token',
    'marazul_current_user', 
    'marazul_recent_login',
    'marazul_cart_v1'
  ];
  
  let html = '<div class="code-block">';
  
  keys.forEach(key => {
    const value = localStorage.getItem(key);
    const display = value ? (value.length > 50 ? value.substring(0, 50) + '...' : value) : 'NULL';
    
    log(`${key}: ${display}`, value ? 'success' : 'warning');
    
    html += `<strong>${key}:</strong><br>`;
    html += value ? `<span class="text-success">${display}</span>` : '<span class="text-warning">NULL</span>';
    html += '<br><br>';
  });
  
  html += '</div>';
  
  // Verificar isAuthenticated
  const isAuth = isAuthenticated();
  log(`isAuthenticated(): ${isAuth}`, isAuth ? 'success' : 'warning');
  
  html += `<div class="alert alert-${isAuth ? 'success' : 'warning'} mt-3">
    <strong>isAuthenticated():</strong> ${isAuth ? 'TRUE - Usuario autenticado' : 'FALSE - No autenticado'}
  </div>`;
  
  $('#result4').html(html);
}

function clearAllStorage() {
  localStorage.removeItem('marazul_auth_token');
  localStorage.removeItem('marazul_current_user');
  localStorage.removeItem('marazul_recent_login');
  log('localStorage limpiado', 'success');
  test4_LocalStorage();
}

// ═══════════════════════════════════════════════════════════════════════════
// TEST 5: SIMULAR FLUJO COMPLETO
// ═══════════════════════════════════════════════════════════════════════════

async function test5_FullFlow() {
  log('═══ TEST 5: Simulando Flujo Completo ═══', 'info');
  
  // Paso 1: Verificar si hay sesión
  log('Paso 1: Verificar sesión actual', 'info');
  if (isAuthenticated()) {
    log('  Ya hay sesión activa', 'success');
    const user = getCurrentUser();
    log(`  Usuario: ${user?.email}`, 'success');
  } else {
    log('  No hay sesión activa', 'warning');
    log('  Ejecuta primero el Test 3 para hacer login', 'warning');
    
    $('#result5').html(`
      <div class="alert alert-warning">
        No hay sesión activa. Ejecuta primero el <strong>Test 3</strong> para hacer login.
      </div>
    `);
    return;
  }
  
  // Paso 2: Verificar initHeader
  log('Paso 2: Verificar initHeader()', 'info');
  if (typeof initHeader === 'function') {
    log('  initHeader existe', 'success');
  } else {
    log('  initHeader NO EXISTE', 'error');
  }
  
  // Paso 3: Crear un header temporal para probar
  log('Paso 3: Creando header temporal para test', 'info');
  
  // Crear contenedor temporal
  if (!$('#test-header-container').length) {
    $('body').prepend('<div id="test-header-container" style="background:#16213e;padding:20px;margin-bottom:20px;border-radius:10px;"><div id="user-area"></div></div>');
  }
  
  // Paso 4: Ejecutar initHeader
  log('Paso 4: Ejecutando initHeader()', 'info');
  try {
    initHeader();
    log('  initHeader() ejecutado sin errores', 'success');
    
    // Verificar qué se renderizó
    setTimeout(() => {
      const userAreaContent = $('#user-area').html();
      log('Paso 5: Verificando contenido de #user-area', 'info');
      
      if (userAreaContent.includes('dropdown')) {
        log('  ÉXITO: Se renderizó el dropdown de usuario', 'success');
        $('#result5').html(`
          <div class="alert alert-success">
            <strong>ÉXITO!</strong> El flujo funciona correctamente.<br>
            El header muestra el dropdown de usuario autenticado.
          </div>
        `);
      } else if (userAreaContent.includes('Iniciar')) {
        log('  PROBLEMA: Se renderizó el botón de login (no dropdown)', 'error');
        log('  Esto indica que isAuthenticated() retornó false', 'error');
        $('#result5').html(`
          <div class="alert alert-danger">
            <strong>PROBLEMA:</strong> Se renderizó el botón de login en lugar del dropdown.<br>
            Esto indica que <code>isAuthenticated()</code> retorna <code>false</code> aunque hay datos en localStorage.
          </div>
        `);
      } else {
        log('  Contenido inesperado en #user-area', 'warning');
        logObject('Contenido', userAreaContent);
      }
    }, 500);
    
  } catch (error) {
    log(`  Error ejecutando initHeader(): ${error.message}`, 'error');
  }
}

// ═══════════════════════════════════════════════════════════════════════════
// INICIALIZACIÓN
// ═══════════════════════════════════════════════════════════════════════════

$(document).ready(function() {
  log('Página de debug cargada', 'success');
  log(`API URL: ${CONFIG?.API_URL || 'NO DEFINIDA'}`, 'info');
  log(`isAuthenticated: ${isAuthenticated()}`, isAuthenticated() ? 'success' : 'warning');
  
  // Auto-ejecutar test de dependencias
  setTimeout(test1_Dependencies, 500);
});
</script>

</body>
</html>
