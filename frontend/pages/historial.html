<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Historial de compras - MarAzul">
  <title>Mis Compras - MarAzul</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  
  <!-- Custom CSS -->
  <link rel="stylesheet" href="../css/variables.css">
  <link rel="stylesheet" href="../css/main.css">
</head>
<body class="bg-light">
  
  <!-- Header Container -->
  <div id="header-container"></div>
  
  <!-- Page Header -->
  <section class="bg-white border-bottom py-3 py-md-4">
    <div class="container">
      <div class="row align-items-center">
        <div class="col">
          <h1 class="h3 mb-0 fw-bold">Mis Compras</h1>
        </div>
        <div class="col-auto">
          <a href="../index.html" class="btn btn-outline-primary btn-sm">
            <i class="bi bi-plus-lg me-1"></i> Nueva Compra
          </a>
        </div>
      </div>
    </div>
  </section>
  
  <!-- Main Content -->
  <main class="container py-4">
    <div class="row">
      
      <!-- Sidebar -->
      <aside class="col-lg-3 mb-4 mb-lg-0">
        <div class="card border-0 shadow-sm sticky-lg-top" style="top: 1rem;">
          <div class="card-body">
            <h5 class="card-title fw-bold mb-3">Mi Cuenta</h5>
            <nav class="nav flex-column gap-1">
              <a href="historial.html" class="nav-link active bg-primary bg-opacity-10 text-primary rounded">
                <i class="bi bi-bag-check me-2"></i> Mis Compras
              </a>
              <a href="ajustes.html" class="nav-link text-dark">
                <i class="bi bi-person me-2"></i> Perfil
              </a>
              <a href="ajustes.html#direcciones" class="nav-link text-dark">
                <i class="bi bi-geo-alt me-2"></i> Direcciones
              </a>
              <a href="ajustes.html#seguridad" class="nav-link text-dark">
                <i class="bi bi-shield-lock me-2"></i> Seguridad
              </a>
            </nav>
          </div>
        </div>
      </aside>
      
      <!-- Orders Content -->
      <div class="col-lg-9">
        
        <!-- Filters -->
        <div class="card border-0 shadow-sm mb-4">
          <div class="card-body">
            <div class="row g-3 align-items-end">
              
              <!-- Search -->
              <div class="col-md-4">
                <label for="search-order" class="form-label small fw-semibold">
                  Buscar pedido
                </label>
                <div class="input-group">
                  <span class="input-group-text bg-white">
                    <i class="bi bi-search"></i>
                  </span>
                  <input 
                    type="text" 
                    class="form-control" 
                    id="search-order"
                    placeholder="Número de orden...">
                </div>
              </div>
              
              <!-- Status Filter -->
              <div class="col-md-4">
                <label for="filter-status" class="form-label small fw-semibold">
                  Estado
                </label>
                <select class="form-select" id="filter-status">
                  <option value="">Todos los estados</option>
                  <option value="pending">Pendiente</option>
                  <option value="paid">Pagado</option>
                  <option value="shipped">Enviado</option>
                  <option value="delivered">Entregado</option>
                  <option value="cancelled">Cancelado</option>
                </select>
              </div>
              
              <!-- Date Range -->
              <div class="col-md-4">
                <label for="filter-date" class="form-label small fw-semibold">
                  Período
                </label>
                <select class="form-select" id="filter-date">
                  <option value="all">Todo el tiempo</option>
                  <option value="30">Últimos 30 días</option>
                  <option value="90">Últimos 3 meses</option>
                  <option value="180">Últimos 6 meses</option>
                  <option value="365">Último año</option>
                </select>
              </div>
              
            </div>
          </div>
        </div>
        
        <!-- Orders List -->
        <div id="orders-container">
          
          <!-- Loading State -->
          <div id="loading-state" class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="text-muted mt-3">Cargando tus pedidos...</p>
          </div>
          
          <!-- Empty State (hidden by default) -->
          <div id="empty-state" class="card border-0 shadow-sm text-center py-5 d-none">
            <div class="card-body">
              <i class="bi bi-bag-x text-muted" style="font-size: 4rem;"></i>
              <h3 class="h5 fw-bold mt-4 mb-2">Aún no has realizado compras</h3>
              <p class="text-muted mb-4">
                Explora nuestros productos y realiza tu primera compra
              </p>
              <a href="../index.html" class="btn btn-primary">
                Ver Productos
              </a>
            </div>
          </div>
          
          <!-- Orders will be rendered here by JavaScript -->
          <div id="orders-list"></div>
          
        </div>
        
        <!-- Pagination -->
        <nav aria-label="Paginación de pedidos" id="pagination-container" class="mt-4 d-none">
          <ul class="pagination justify-content-center mb-0">
            <li class="page-item disabled">
              <a class="page-link" href="#" tabindex="-1">
                <i class="bi bi-chevron-left"></i>
              </a>
            </li>
            <li class="page-item active"><a class="page-link" href="#">1</a></li>
            <li class="page-item"><a class="page-link" href="#">2</a></li>
            <li class="page-item"><a class="page-link" href="#">3</a></li>
            <li class="page-item">
              <a class="page-link" href="#">
                <i class="bi bi-chevron-right"></i>
              </a>
            </li>
          </ul>
        </nav>
        
      </div>
      
    </div>
  </main>
  
  <!-- Order Detail Modal -->
  <div class="modal fade" id="orderDetailModal" tabindex="-1" aria-labelledby="orderDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title fw-bold" id="orderDetailModalLabel">Detalle del Pedido</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body" id="order-detail-content">
          <!-- Order details will be loaded here -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Footer Container -->
  <div id="footer-container"></div>
  
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- Custom JS -->
  <script type="module">
    import { OrderService } from '../js/services/OrderService.js';
    import { formatCurrency, formatDate, showAlert } from '../js/utils.js';
    
    // State
    let orders = [];
    let filteredOrders = [];
    let currentPage = 1;
    const ordersPerPage = 5;
    
    // DOM Elements
    const loadingState = document.getElementById('loading-state');
    const emptyState = document.getElementById('empty-state');
    const ordersList = document.getElementById('orders-list');
    const paginationContainer = document.getElementById('pagination-container');
    
    // Status badges
    const statusConfig = {
      pending_payment: { label: 'Pendiente', class: 'warning' },
      paid: { label: 'Pagado', class: 'success' },
      shipped: { label: 'Enviado', class: 'info' },
      delivered: { label: 'Entregado', class: 'success' },
      cancelled: { label: 'Cancelado', class: 'danger' }
    };
    
    // Load orders
    async function loadOrders() {
      try {
        loadingState.classList.remove('d-none');
        emptyState.classList.add('d-none');
        ordersList.innerHTML = '';
        
        const response = await OrderService.getUserOrders();
        
        if (response.success && response.data) {
          orders = response.data;
          filteredOrders = [...orders];
          renderOrders();
        }
        
      } catch (error) {
        console.error('Error loading orders:', error);
        showAlert('danger', 'Error al cargar los pedidos');
      } finally {
        loadingState.classList.add('d-none');
      }
    }
    
    // Render orders
    function renderOrders() {
      if (filteredOrders.length === 0) {
        emptyState.classList.remove('d-none');
        paginationContainer.classList.add('d-none');
        return;
      }
      
      emptyState.classList.add('d-none');
      
      const startIndex = (currentPage - 1) * ordersPerPage;
      const endIndex = startIndex + ordersPerPage;
      const pageOrders = filteredOrders.slice(startIndex, endIndex);
      
      ordersList.innerHTML = pageOrders.map(order => createOrderCard(order)).join('');
      
      // Show pagination if needed
      if (filteredOrders.length > ordersPerPage) {
        renderPagination();
        paginationContainer.classList.remove('d-none');
      } else {
        paginationContainer.classList.add('d-none');
      }
      
      // Attach event listeners
      attachOrderEventListeners();
    }
    
    // Create order card HTML
    function createOrderCard(order) {
      const status = statusConfig[order.status] || statusConfig.pending_payment;
      
      return `
        <div class="card border-0 shadow-sm mb-3 order-card" data-order-id="${order._id}">
          <div class="card-body">
            <div class="row g-3 align-items-center">
              
              <div class="col-md-8">
                <div class="d-flex align-items-center mb-2">
                  <span class="badge bg-${status.class} me-2">${status.label}</span>
                  <span class="text-muted small">
                    <i class="bi bi-calendar3 me-1"></i>
                    ${formatDate(order.createdAt)}
                  </span>
                </div>
                
                <h6 class="fw-bold mb-1">Pedido #${order.orderNumber}</h6>
                <p class="text-muted small mb-0">
                  ${order.items?.length || 0} producto(s) • 
                  Total: ${formatCurrency(order.total)}
                </p>
              </div>
              
              <div class="col-md-4 text-md-end">
                <button 
                  class="btn btn-outline-primary btn-sm view-order-btn"
                  data-order-id="${order._id}">
                  <i class="bi bi-eye me-1"></i>
                  Ver Detalle
                </button>
              </div>
              
            </div>
          </div>
        </div>
      `;
    }
    
    // Render pagination
    function renderPagination() {
      const totalPages = Math.ceil(filteredOrders.length / ordersPerPage);
      // Implementation would go here
    }
    
    // Attach event listeners to order cards
    function attachOrderEventListeners() {
      document.querySelectorAll('.view-order-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const orderId = e.currentTarget.dataset.orderId;
          await showOrderDetail(orderId);
        });
      });
    }
    
    // Show order detail modal
    async function showOrderDetail(orderId) {
      try {
        const response = await OrderService.getOrderById(orderId);
        
        if (response.success && response.data) {
          const order = response.data.order;
          const items = response.data.items;
          
          const content = `
            <div class="mb-4">
              <h6 class="fw-bold mb-3">Información del Pedido</h6>
              <div class="row g-2 text-muted small">
                <div class="col-6">Número de orden:</div>
                <div class="col-6 text-end fw-semibold">${order.orderNumber}</div>
                <div class="col-6">Fecha:</div>
                <div class="col-6 text-end">${formatDate(order.createdAt)}</div>
                <div class="col-6">Estado:</div>
                <div class="col-6 text-end">
                  <span class="badge bg-${statusConfig[order.status]?.class || 'secondary'}">
                    ${statusConfig[order.status]?.label || 'Desconocido'}
                  </span>
                </div>
              </div>
            </div>
            
            <div class="mb-4">
              <h6 class="fw-bold mb-3">Productos</h6>
              ${items.map(item => `
                <div class="d-flex align-items-center mb-3 pb-3 border-bottom">
                  <img 
                    src="${item.productId?.mainImage || 'https://via.placeholder.com/60'}" 
                    alt="${item.productName}"
                    class="rounded"
                    style="width: 60px; height: 60px; object-fit: cover;">
                  <div class="flex-grow-1 ms-3">
                    <h6 class="mb-1">${item.productName}</h6>
                    <small class="text-muted">
                      ${item.quantity} x ${formatCurrency(item.unitPrice)}
                    </small>
                  </div>
                  <div class="text-end fw-semibold">
                    ${formatCurrency(item.subtotal)}
                  </div>
                </div>
              `).join('')}
            </div>
            
            <div class="border-top pt-3">
              <div class="row g-2 text-muted">
                <div class="col-6">Subtotal:</div>
                <div class="col-6 text-end">${formatCurrency(order.subtotal)}</div>
                <div class="col-6">Envío:</div>
                <div class="col-6 text-end">${formatCurrency(order.shippingCost)}</div>
                <div class="col-6 fw-bold fs-5 text-dark">Total:</div>
                <div class="col-6 text-end fw-bold fs-5 text-dark">${formatCurrency(order.total)}</div>
              </div>
            </div>
          `;
          
          document.getElementById('order-detail-content').innerHTML = content;
          const modal = new bootstrap.Modal(document.getElementById('orderDetailModal'));
          modal.show();
        }
      } catch (error) {
        console.error('Error loading order detail:', error);
        showAlert('danger', 'Error al cargar el detalle del pedido');
      }
    }
    
    // Filters
    document.getElementById('search-order')?.addEventListener('input', applyFilters);
    document.getElementById('filter-status')?.addEventListener('change', applyFilters);
    document.getElementById('filter-date')?.addEventListener('change', applyFilters);
    
    function applyFilters() {
      // Filter logic would go here
      renderOrders();
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadOrders();
    });
  </script>
  
</body>
</html>