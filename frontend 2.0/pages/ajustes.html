<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Configuración de cuenta - MarAzul">
  <meta name="robots" content="noindex, nofollow">
  <title>Ajustes de Cuenta - MarAzul</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  
  <!-- Custom CSS -->
  <link rel="stylesheet" href="../css/variables.css">
  <link rel="stylesheet" href="../css/main.css">
  
  <style>
    .avatar-upload {
      position: relative;
      cursor: pointer;
      transition: transform 0.2s;
    }
    
    .avatar-upload:hover {
      transform: scale(1.05);
    }
    
    .avatar-upload .upload-overlay {
      position: absolute;
      bottom: 0;
      right: 0;
      background: var(--bs-primary);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    
    .address-card {
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }
    
    .address-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .address-card.default {
      border-color: var(--bs-primary);
    }
  </style>
</head>
<body class="bg-light">
  
  <!-- Header Container -->
  <div id="header-container"></div>
  
  <!-- Page Header -->
  <section class="bg-white border-bottom py-3 py-md-4">
    <div class="container">
      <h1 class="h3 mb-0 fw-bold">Configuración de Cuenta</h1>
    </div>
  </section>
  
  <!-- Main Content -->
  <main class="container py-4">
    <div class="row">
      
      <!-- Sidebar -->
      <aside class="col-lg-3 mb-4 mb-lg-0">
        <div class="card border-0 shadow-sm sticky-lg-top" style="top: 1rem;">
          <div class="card-body">
            <h5 class="card-title fw-bold mb-3">Mi Cuenta</h5>
            <nav class="nav flex-column gap-1">
              <a href="historial.html" class="nav-link text-dark">
                <i class="bi bi-bag-check me-2"></i> Mis Compras
              </a>
              <a href="#perfil" class="nav-link active bg-primary bg-opacity-10 text-primary rounded" data-bs-toggle="tab" role="tab" aria-controls="perfil" aria-selected="true">
                <i class="bi bi-person me-2"></i> Perfil
              </a>
              <a href="#direcciones" class="nav-link text-dark" data-bs-toggle="tab" role="tab" aria-controls="direcciones" aria-selected="false">
                <i class="bi bi-geo-alt me-2"></i> Direcciones
              </a>
              <a href="#seguridad" class="nav-link text-dark" data-bs-toggle="tab" role="tab" aria-controls="seguridad" aria-selected="false">
                <i class="bi bi-shield-lock me-2"></i> Seguridad
              </a>
            </nav>
          </div>
        </div>
      </aside>
      
      <!-- Settings Content -->
      <div class="col-lg-9">
        
        <!-- Alert Messages -->
        <div id="alert-container"></div>
        
        <!-- Tab Content -->
        <div class="tab-content">
          
          <!-- ============================================ -->
          <!-- PROFILE TAB -->
          <!-- ============================================ -->
          <div class="tab-pane fade show active" id="perfil" role="tabpanel" aria-labelledby="perfil-tab">
            <div class="card border-0 shadow-sm">
              <div class="card-body p-4">
                
                <div class="d-flex justify-content-between align-items-center mb-4">
                  <h5 class="card-title fw-bold mb-0">Información Personal</h5>
                  <span class="badge bg-success">
                    <i class="bi bi-check-circle me-1"></i>Verificado
                  </span>
                </div>
                
                <!-- Profile Form -->
                <form id="profile-form" novalidate>
                  
                  <!-- Avatar -->
                  <div class="text-center mb-4">
                    <div class="avatar-upload d-inline-block">
                      <img 
                        src="https://ui-avatars.com/api/?name=Usuario&size=120&background=003366&color=fff" 
                        alt="Avatar del usuario" 
                        class="rounded-circle"
                        id="avatar-preview"
                        style="width: 120px; height: 120px; object-fit: cover;">
                      <label 
                        for="avatar-input" 
                        class="upload-overlay text-white"
                        title="Cambiar foto de perfil">
                        <i class="bi bi-camera-fill"></i>
                      </label>
                      <input 
                        type="file" 
                        id="avatar-input" 
                        class="d-none" 
                        accept="image/jpeg,image/png,image/webp"
                        aria-label="Subir foto de perfil">
                    </div>
                    <div class="mt-2">
                      <small class="text-muted">JPG, PNG o WEBP. Máx. 2MB</small>
                    </div>
                  </div>
                  
                  <div class="row g-3">
                    
                    <!-- First Name -->
                    <div class="col-md-6">
                      <label for="firstName" class="form-label fw-semibold">
                        Nombre <span class="text-danger">*</span>
                      </label>
                      <input 
                        type="text" 
                        class="form-control" 
                        id="firstName" 
                        name="firstName"
                        required
                        autocomplete="given-name">
                      <div class="invalid-feedback">El nombre es requerido.</div>
                    </div>
                    
                    <!-- Last Name -->
                    <div class="col-md-6">
                      <label for="lastName" class="form-label fw-semibold">
                        Apellido <span class="text-danger">*</span>
                      </label>
                      <input 
                        type="text" 
                        class="form-control" 
                        id="lastName" 
                        name="lastName"
                        required
                        autocomplete="family-name">
                      <div class="invalid-feedback">El apellido es requerido.</div>
                    </div>
                    
                    <!-- Email (readonly) -->
                    <div class="col-12">
                      <label for="email" class="form-label fw-semibold">
                        Correo Electrónico
                      </label>
                      <input 
                        type="email" 
                        class="form-control" 
                        id="email" 
                        name="email"
                        readonly
                        autocomplete="email">
                      <div class="form-text">
                        <i class="bi bi-info-circle me-1"></i>
                        El correo no puede ser modificado
                      </div>
                    </div>
                    
                    <!-- Phone -->
                    <div class="col-12">
                      <label for="phone" class="form-label fw-semibold">
                        Teléfono <span class="text-danger">*</span>
                      </label>
                      <div class="input-group">
                        <span class="input-group-text">+56</span>
                        <input 
                          type="tel" 
                          class="form-control" 
                          id="phone" 
                          name="phone"
                          pattern="[0-9]{8,9}"
                          required
                          autocomplete="tel">
                      </div>
                      <div class="invalid-feedback">Ingresa un teléfono válido (8-9 dígitos).</div>
                    </div>
                    
                    <!-- Save Button -->
                    <div class="col-12 mt-4">
                      <button type="submit" class="btn btn-primary" id="save-profile-btn">
                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        <span class="btn-text">
                          <i class="bi bi-check-lg me-1"></i>Guardar Cambios
                        </span>
                      </button>
                    </div>
                    
                  </div>
                  
                </form>
                
              </div>
            </div>
          </div>
          
          <!-- ============================================ -->
          <!-- ADDRESSES TAB -->
          <!-- ============================================ -->
          <div class="tab-pane fade" id="direcciones" role="tabpanel" aria-labelledby="direcciones-tab">
            <div class="card border-0 shadow-sm mb-3">
              <div class="card-body p-4">
                
                <div class="d-flex justify-content-between align-items-center mb-4">
                  <h5 class="card-title fw-bold mb-0">Mis Direcciones</h5>
                  <button 
                    class="btn btn-primary btn-sm" 
                    data-bs-toggle="modal" 
                    data-bs-target="#addressModal"
                    onclick="openAddressModal()"
                    aria-label="Agregar nueva dirección">
                    <i class="bi bi-plus-lg me-1"></i>
                    Nueva Dirección
                  </button>
                </div>
                
                <!-- Addresses List -->
                <div id="addresses-list">
                  
                  <!-- Loading -->
                  <div id="addresses-loading" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                      <span class="visually-hidden">Cargando direcciones...</span>
                    </div>
                  </div>
                  
                  <!-- Empty State -->
                  <div id="addresses-empty" class="text-center py-5 d-none">
                    <i class="bi bi-geo text-muted" style="font-size: 3rem;"></i>
                    <h6 class="fw-bold mt-3 mb-2">No tienes direcciones guardadas</h6>
                    <p class="text-muted small">Agrega una dirección para facilitar tus compras</p>
                    <button 
                      class="btn btn-primary" 
                      data-bs-toggle="modal" 
                      data-bs-target="#addressModal"
                      onclick="openAddressModal()">
                      <i class="bi bi-plus-lg me-1"></i>
                      Agregar Dirección
                    </button>
                  </div>
                  
                  <!-- Addresses Grid -->
                  <div id="addresses-grid" class="row g-3 d-none">
                    <!-- Addresses will be rendered here -->
                  </div>
                  
                </div>
                
              </div>
            </div>
          </div>
          
          <!-- ============================================ -->
          <!-- SECURITY TAB -->
          <!-- ============================================ -->
          <div class="tab-pane fade" id="seguridad" role="tabpanel" aria-labelledby="seguridad-tab">
            
            <!-- Change Password -->
            <div class="card border-0 shadow-sm mb-4">
              <div class="card-body p-4">
                
                <h5 class="card-title fw-bold mb-4">Cambiar Contraseña</h5>
                
                <!-- Password Form -->
                <form id="password-form" novalidate>
                  
                  <div class="row g-3">
                    
                    <!-- Current Password -->
                    <div class="col-12">
                      <label for="currentPassword" class="form-label fw-semibold">
                        Contraseña Actual <span class="text-danger">*</span>
                      </label>
                      <div class="input-group">
                        <input 
                          type="password" 
                          class="form-control" 
                          id="currentPassword" 
                          name="currentPassword"
                          required
                          autocomplete="current-password">
                        <button 
                          class="btn btn-outline-secondary" 
                          type="button"
                          onclick="togglePasswordVisibility('currentPassword')"
                          aria-label="Mostrar/ocultar contraseña">
                          <i class="bi bi-eye"></i>
                        </button>
                      </div>
                      <div class="invalid-feedback">La contraseña actual es requerida.</div>
                    </div>
                    
                    <!-- New Password -->
                    <div class="col-md-6">
                      <label for="newPassword" class="form-label fw-semibold">
                        Nueva Contraseña <span class="text-danger">*</span>
                      </label>
                      <div class="input-group">
                        <input 
                          type="password" 
                          class="form-control" 
                          id="newPassword" 
                          name="newPassword"
                          minlength="6"
                          required
                          autocomplete="new-password">
                        <button 
                          class="btn btn-outline-secondary" 
                          type="button"
                          onclick="togglePasswordVisibility('newPassword')"
                          aria-label="Mostrar/ocultar contraseña">
                          <i class="bi bi-eye"></i>
                        </button>
                      </div>
                      <div class="form-text">Mínimo 6 caracteres</div>
                      <div class="invalid-feedback">Mínimo 6 caracteres.</div>
                    </div>
                    
                    <!-- Confirm New Password -->
                    <div class="col-md-6">
                      <label for="confirmPassword" class="form-label fw-semibold">
                        Confirmar Nueva Contraseña <span class="text-danger">*</span>
                      </label>
                      <div class="input-group">
                        <input 
                          type="password" 
                          class="form-control" 
                          id="confirmPassword" 
                          name="confirmPassword"
                          minlength="6"
                          required
                          autocomplete="new-password">
                        <button 
                          class="btn btn-outline-secondary" 
                          type="button"
                          onclick="togglePasswordVisibility('confirmPassword')"
                          aria-label="Mostrar/ocultar contraseña">
                          <i class="bi bi-eye"></i>
                        </button>
                      </div>
                      <div class="invalid-feedback">Las contraseñas no coinciden.</div>
                    </div>
                    
                    <!-- Save Button -->
                    <div class="col-12 mt-4">
                      <button type="submit" class="btn btn-primary" id="save-password-btn">
                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        <span class="btn-text">
                          <i class="bi bi-shield-check me-1"></i>Cambiar Contraseña
                        </span>
                      </button>
                    </div>
                    
                  </div>
                  
                </form>
                
              </div>
            </div>
            
            <!-- Delete Account -->
            <div class="card border-danger shadow-sm">
              <div class="card-body p-4">
                <h5 class="card-title fw-bold text-danger mb-3">
                  <i class="bi bi-exclamation-triangle me-2"></i>Zona de Peligro
                </h5>
                <p class="text-muted mb-3">
                  Una vez que elimines tu cuenta, no hay vuelta atrás. Se eliminarán permanentemente:
                </p>
                <ul class="text-muted mb-4">
                  <li>Tu perfil y datos personales</li>
                  <li>Tu historial de compras</li>
                  <li>Tus direcciones guardadas</li>
                  <li>Cualquier dato asociado a tu cuenta</li>
                </ul>
                <button 
                  class="btn btn-outline-danger" 
                  data-bs-toggle="modal" 
                  data-bs-target="#deleteAccountModal">
                  <i class="bi bi-trash me-1"></i>
                  Eliminar Cuenta
                </button>
              </div>
            </div>
            
          </div>
          
        </div>
        
      </div>
      
    </div>
  </main>
  
  <!-- ============================================ -->
  <!-- ADDRESS MODAL -->
  <!-- ============================================ -->
  <div class="modal fade" id="addressModal" tabindex="-1" aria-labelledby="addressModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title fw-bold" id="addressModalLabel">Nueva Dirección</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <form id="address-form" novalidate>
            <input type="hidden" id="address-id" name="addressId">
            
            <div class="row g-3">
              
              <!-- Address Name -->
              <div class="col-md-6">
                <label for="addressName" class="form-label fw-semibold">
                  Nombre de la Dirección <span class="text-danger">*</span>
                </label>
                <input 
                  type="text" 
                  class="form-control" 
                  id="addressName" 
                  name="addressName"
                  placeholder="Casa, Oficina, etc."
                  required>
                <div class="invalid-feedback">Ingresa un nombre para la dirección.</div>
              </div>
              
              <!-- Recipient Name -->
              <div class="col-md-6">
                <label for="recipientName" class="form-label fw-semibold">
                  Nombre del Destinatario <span class="text-danger">*</span>
                </label>
                <input 
                  type="text" 
                  class="form-control" 
                  id="recipientName" 
                  name="recipientName"
                  placeholder="Nombre completo"
                  required
                  autocomplete="name">
                <div class="invalid-feedback">Ingresa el nombre del destinatario.</div>
              </div>
              
              <!-- Street -->
              <div class="col-md-8">
                <label for="street" class="form-label fw-semibold">
                  Calle <span class="text-danger">*</span>
                </label>
                <input 
                  type="text" 
                  class="form-control" 
                  id="street" 
                  name="street"
                  placeholder="Nombre de la calle"
                  required
                  autocomplete="street-address">
                <div class="invalid-feedback">Ingresa el nombre de la calle.</div>
              </div>
              
              <!-- Number -->
              <div class="col-md-4">
                <label for="number" class="form-label fw-semibold">
                  Número <span class="text-danger">*</span>
                </label>
                <input 
                  type="text" 
                  class="form-control" 
                  id="number" 
                  name="number"
                  placeholder="123"
                  required>
                <div class="invalid-feedback">Ingresa el número.</div>
              </div>
              
              <!-- Apartment -->
              <div class="col-md-6">
                <label for="apartment" class="form-label fw-semibold">
                  Depto/Casa (Opcional)
                </label>
                <input 
                  type="text" 
                  class="form-control" 
                  id="apartment" 
                  name="apartment"
                  placeholder="Depto 101, Casa A">
              </div>
              
              <!-- Commune -->
              <div class="col-md-6">
                <label for="commune" class="form-label fw-semibold">
                  Comuna <span class="text-danger">*</span>
                </label>
                <input 
                  type="text" 
                  class="form-control" 
                  id="commune" 
                  name="commune"
                  placeholder="Providencia"
                  required>
                <div class="invalid-feedback">Ingresa la comuna.</div>
              </div>
              
              <!-- City -->
              <div class="col-md-6">
                <label for="city" class="form-label fw-semibold">
                  Ciudad <span class="text-danger">*</span>
                </label>
                <input 
                  type="text" 
                  class="form-control" 
                  id="city" 
                  name="city"
                  placeholder="Santiago"
                  required
                  autocomplete="address-level2">
                <div class="invalid-feedback">Ingresa la ciudad.</div>
              </div>
              
              <!-- Region -->
              <div class="col-md-6">
                <label for="region" class="form-label fw-semibold">
                  Región <span class="text-danger">*</span>
                </label>
                <select 
                  class="form-select" 
                  id="region" 
                  name="region"
                  required>
                  <option value="">Selecciona una región</option>
                  <option value="Región Metropolitana">Región Metropolitana</option>
                  <option value="Región de Valparaíso">Región de Valparaíso</option>
                  <option value="Región del Biobío">Región del Biobío</option>
                  <option value="Región de La Araucanía">Región de La Araucanía</option>
                  <option value="Región de Los Lagos">Región de Los Lagos</option>
                  <option value="Región de Antofagasta">Región de Antofagasta</option>
                  <option value="Región de Coquimbo">Región de Coquimbo</option>
                  <option value="Región de O'Higgins">Región de O'Higgins</option>
                  <option value="Región del Maule">Región del Maule</option>
                  <option value="Región de Ñuble">Región de Ñuble</option>
                  <option value="Región de Los Ríos">Región de Los Ríos</option>
                  <option value="Región de Aysén">Región de Aysén</option>
                  <option value="Región de Magallanes">Región de Magallanes</option>
                  <option value="Región de Arica y Parinacota">Región de Arica y Parinacota</option>
                  <option value="Región de Tarapacá">Región de Tarapacá</option>
                  <option value="Región de Atacama">Región de Atacama</option>
                </select>
                <div class="invalid-feedback">Selecciona una región.</div>
              </div>
              
              <!-- Phone -->
              <div class="col-md-6">
                <label for="addressPhone" class="form-label fw-semibold">
                  Teléfono de Contacto <span class="text-danger">*</span>
                </label>
                <div class="input-group">
                  <span class="input-group-text">+56</span>
                  <input 
                    type="tel" 
                    class="form-control" 
                    id="addressPhone" 
                    name="phone"
                    placeholder="912345678"
                    pattern="[0-9]{8,9}"
                    required
                    autocomplete="tel">
                </div>
                <div class="invalid-feedback">Ingresa un teléfono válido.</div>
              </div>
              
              <!-- Postal Code -->
              <div class="col-md-6">
                <label for="postalCode" class="form-label fw-semibold">
                  Código Postal (Opcional)
                </label>
                <input 
                  type="text" 
                  class="form-control" 
                  id="postalCode" 
                  name="postalCode"
                  placeholder="8320000"
                  autocomplete="postal-code">
              </div>
              
              <!-- Reference -->
              <div class="col-12">
                <label for="reference" class="form-label fw-semibold">
                  Referencias Adicionales (Opcional)
                </label>
                <textarea 
                  class="form-control" 
                  id="reference" 
                  name="reference"
                  rows="2"
                  placeholder="Ej: Portón azul, cerca del supermercado"></textarea>
              </div>
              
              <!-- Default Checkbox -->
              <div class="col-12">
                <div class="form-check">
                  <input 
                    class="form-check-input" 
                    type="checkbox" 
                    id="isDefault" 
                    name="isDefault">
                  <label class="form-check-label" for="isDefault">
                    Usar como dirección predeterminada
                  </label>
                </div>
              </div>
              
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" id="save-address-btn">
            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
            <span class="btn-text">Guardar Dirección</span>
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- ============================================ -->
  <!-- DELETE ADDRESS MODAL -->
  <!-- ============================================ -->
  <div class="modal fade" id="deleteAddressModal" tabindex="-1" aria-labelledby="deleteAddressModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="deleteAddressModalLabel">Eliminar Dirección</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <p>¿Estás seguro de que deseas eliminar esta dirección?</p>
          <p class="text-muted mb-0">Esta acción no se puede deshacer.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-danger" id="confirm-delete-address-btn">
            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
            <span class="btn-text">Eliminar</span>
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- ============================================ -->
  <!-- DELETE ACCOUNT MODAL -->
  <!-- ============================================ -->
  <div class="modal fade" id="deleteAccountModal" tabindex="-1" aria-labelledby="deleteAccountModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header border-danger">
          <h5 class="modal-title fw-bold text-danger" id="deleteAccountModalLabel">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>Eliminar Cuenta
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-danger" role="alert">
            <strong>¡Advertencia!</strong> Esta acción es irreversible.
          </div>
          <p class="mb-3">Para confirmar, ingresa tu contraseña:</p>
          <form id="delete-account-form" novalidate>
            <div class="mb-3">
              <label for="deleteAccountPassword" class="form-label fw-semibold">
                Contraseña <span class="text-danger">*</span>
              </label>
              <input 
                type="password" 
                class="form-control" 
                id="deleteAccountPassword"
                name="password"
                required
                autocomplete="current-password">
              <div class="invalid-feedback">La contraseña es requerida.</div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-danger" id="confirm-delete-account-btn">
            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
            <span class="btn-text">Eliminar Mi Cuenta</span>
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Footer Container -->
  <div id="footer-container"></div>
  
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- Custom JS -->
  <script type="module">
    import { AuthService } from '../js/services/AuthService.js';
    import { showAlert, validateForm, setButtonLoading } from '../js/utils.js';
    
    // ============================================
    // UTILITY FUNCTIONS
    // ============================================
    
    // Toggle password visibility
    window.togglePasswordVisibility = function(inputId) {
      const input = document.getElementById(inputId);
      const button = input.nextElementSibling;
      const icon = button.querySelector('i');
      
      if (input.type === 'password') {
        input.type = 'text';
        icon.classList.replace('bi-eye', 'bi-eye-slash');
      } else {
        input.type = 'password';
        icon.classList.replace('bi-eye-slash', 'bi-eye');
      }
    };
    
    // ============================================
    // PROFILE TAB
    // ============================================
    
    // Load user profile
    async function loadUserProfile() {
      try {
        const response = await AuthService.getProfile();
        if (response.success && response.data) {
          const user = response.data;
          document.getElementById('firstName').value = user.firstName || '';
          document.getElementById('lastName').value = user.lastName || '';
          document.getElementById('email').value = user.email || '';
          document.getElementById('phone').value = user.phone || '';
          
          // Update avatar
          if (user.avatar) {
            document.getElementById('avatar-preview').src = user.avatar;
          } else {
            const initials = `${user.firstName} ${user.lastName}`;
            document.getElementById('avatar-preview').src = 
              `https://ui-avatars.com/api/?name=${encodeURIComponent(initials)}&size=120&background=003366&color=fff`;
          }
        }
      } catch (error) {
        console.error('Error loading profile:', error);
        showAlert('danger', 'Error al cargar el perfil');
      }
    }
    
    // Handle avatar upload
    document.getElementById('avatar-input')?.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      // Validate file size (2MB max)
      if (file.size > 2 * 1024 * 1024) {
        showAlert('warning', 'La imagen no debe superar los 2MB');
        e.target.value = '';
        return;
      }
      
      // Validate file type
      if (!['image/jpeg', 'image/png', 'image/webp'].includes(file.type)) {
        showAlert('warning', 'Solo se permiten imágenes JPG, PNG o WEBP');
        e.target.value = '';
        return;
      }
      
      // Preview image
      const reader = new FileReader();
      reader.onload = (e) => {
        document.getElementById('avatar-preview').src = e.target.result;
      };
      reader.readAsDataURL(file);
      
      // TODO: Upload to server
      try {
        // const formData = new FormData();
        // formData.append('avatar', file);
        // await AuthService.uploadAvatar(formData);
        showAlert('success', 'Foto de perfil actualizada');
      } catch (error) {
        console.error('Error uploading avatar:', error);
        showAlert('danger', 'Error al subir la foto');
      }
    });
    
    // Profile form submit
    document.getElementById('profile-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!validateForm(e.target)) return;
      
      const btn = document.getElementById('save-profile-btn');
      setButtonLoading(btn, true, 'Guardando...');
      
      try {
        const formData = new FormData(e.target);
        const profileData = {
          firstName: formData.get('firstName'),
          lastName: formData.get('lastName'),
          phone: formData.get('phone')
        };
        
        const response = await AuthService.updateProfile(profileData);
        
        if (response.success) {
          showAlert('success', 'Perfil actualizado correctamente');
        } else {
          showAlert('danger', response.message || 'Error al actualizar el perfil');
        }
      } catch (error) {
        console.error('Error updating profile:', error);
        showAlert('danger', 'Error al actualizar el perfil');
      } finally {
        setButtonLoading(btn, false);
      }
    });
    
    // ============================================
    // ADDRESSES TAB
    // ============================================
    
    let addresses = [];
    let currentAddressId = null;
    let addressToDelete = null;
    
    // Load addresses
    async function loadAddresses() {
      const loading = document.getElementById('addresses-loading');
      const empty = document.getElementById('addresses-empty');
      const grid = document.getElementById('addresses-grid');
      
      loading.classList.remove('d-none');
      empty.classList.add('d-none');
      grid.classList.add('d-none');
      
      try {
        // TODO: Replace with actual API call
        // const response = await AddressService.getAddresses();
        // addresses = response.data;
        
        // Mock data for testing
        addresses = [];
        
        loading.classList.add('d-none');
        
        if (addresses.length === 0) {
          empty.classList.remove('d-none');
        } else {
          grid.classList.remove('d-none');
          renderAddresses();
        }
      } catch (error) {
        console.error('Error loading addresses:', error);
        showAlert('danger', 'Error al cargar las direcciones');
        loading.classList.add('d-none');
      }
    }
    
    // Render addresses
    function renderAddresses() {
      const grid = document.getElementById('addresses-grid');
      grid.innerHTML = '';
      
      addresses.forEach(address => {
        const col = document.createElement('div');
        col.className = 'col-md-6';
        
        const fullAddress = `${address.street} ${address.number}${address.apartment ? ', ' + address.apartment : ''}, ${address.commune}`;
        
        col.innerHTML = `
          <div class="card address-card ${address.isDefault ? 'default' : ''} h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start mb-3">
                <h6 class="card-title mb-0 fw-bold">
                  <i class="bi bi-geo-alt-fill text-primary me-1"></i>
                  ${address.addressName}
                </h6>
                ${address.isDefault ? '<span class="badge bg-primary">Predeterminada</span>' : ''}
              </div>
              <p class="card-text mb-2">
                <strong>${address.recipientName}</strong>
              </p>
              <p class="card-text text-muted small mb-2">
                <i class="bi bi-pin-map me-1"></i>${fullAddress}
              </p>
              <p class="card-text text-muted small mb-2">
                <i class="bi bi-telephone me-1"></i>${address.phone}
              </p>
              ${address.reference ? `<p class="card-text text-muted small mb-3"><i class="bi bi-info-circle me-1"></i>${address.reference}</p>` : ''}
              <div class="d-flex gap-2">
                <button 
                  class="btn btn-sm btn-outline-primary flex-fill" 
                  onclick="editAddress('${address._id || address.id}')">
                  <i class="bi bi-pencil me-1"></i>Editar
                </button>
                <button 
                  class="btn btn-sm btn-outline-danger" 
                  onclick="confirmDeleteAddress('${address._id || address.id}')"
                  aria-label="Eliminar dirección">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </div>
          </div>
        `;
        
        grid.appendChild(col);
      });
    }
    
    // Open address modal
    window.openAddressModal = function() {
      currentAddressId = null;
      document.getElementById('addressModalLabel').textContent = 'Nueva Dirección';
      document.getElementById('address-form').reset();
      document.getElementById('address-form').classList.remove('was-validated');
      document.getElementById('address-id').value = '';
    };
    
    // Edit address
    window.editAddress = function(id) {
      currentAddressId = id;
      const address = addresses.find(a => (a._id || a.id) === id);
      
      if (!address) return;
      
      document.getElementById('addressModalLabel').textContent = 'Editar Dirección';
      document.getElementById('address-id').value = id;
      document.getElementById('addressName').value = address.addressName || '';
      document.getElementById('recipientName').value = address.recipientName || '';
      document.getElementById('street').value = address.street || '';
      document.getElementById('number').value = address.number || '';
      document.getElementById('apartment').value = address.apartment || '';
      document.getElementById('commune').value = address.commune || '';
      document.getElementById('city').value = address.city || '';
      document.getElementById('region').value = address.region || '';
      document.getElementById('addressPhone').value = address.phone || '';
      document.getElementById('postalCode').value = address.postalCode || '';
      document.getElementById('reference').value = address.reference || '';
      document.getElementById('isDefault').checked = address.isDefault || false;
      
      const modal = new bootstrap.Modal(document.getElementById('addressModal'));
      modal.show();
    };
    
    // Save address
    document.getElementById('save-address-btn')?.addEventListener('click', async () => {
      const form = document.getElementById('address-form');
      if (!validateForm(form)) return;
      
      const btn = document.getElementById('save-address-btn');
      setButtonLoading(btn, true, 'Guardando...');
      
      try {
        const formData = new FormData(form);
        const addressData = {
          addressName: formData.get('addressName'),
          recipientName: formData.get('recipientName'),
          street: formData.get('street'),
          number: formData.get('number'),
          apartment: formData.get('apartment'),
          commune: formData.get('commune'),
          city: formData.get('city'),
          region: formData.get('region'),
          phone: formData.get('phone'),
          postalCode: formData.get('postalCode'),
          reference: formData.get('reference'),
          isDefault: formData.get('isDefault') === 'on'
        };
        
        // TODO: Replace with actual API call
        // const response = currentAddressId 
        //   ? await AddressService.updateAddress(currentAddressId, addressData)
        //   : await AddressService.createAddress(addressData);
        
        const modal = bootstrap.Modal.getInstance(document.getElementById('addressModal'));
        modal.hide();
        
        showAlert('success', currentAddressId ? 'Dirección actualizada' : 'Dirección creada exitosamente');
        await loadAddresses();
      } catch (error) {
        console.error('Error saving address:', error);
        showAlert('danger', 'Error al guardar la dirección');
      } finally {
        setButtonLoading(btn, false);
      }
    });
    
    // Confirm delete address
    window.confirmDeleteAddress = function(id) {
      addressToDelete = id;
      const modal = new bootstrap.Modal(document.getElementById('deleteAddressModal'));
      modal.show();
    };
    
    // Delete address
    document.getElementById('confirm-delete-address-btn')?.addEventListener('click', async () => {
      if (!addressToDelete) return;
      
      const btn = document.getElementById('confirm-delete-address-btn');
      setButtonLoading(btn, true, 'Eliminando...');
      
      try {
        // TODO: Replace with actual API call
        // await AddressService.deleteAddress(addressToDelete);
        
        const modal = bootstrap.Modal.getInstance(document.getElementById('deleteAddressModal'));
        modal.hide();
        
        showAlert('success', 'Dirección eliminada exitosamente');
        await loadAddresses();
      } catch (error) {
        console.error('Error deleting address:', error);
        showAlert('danger', 'Error al eliminar la dirección');
      } finally {
        setButtonLoading(btn, false);
      }
    });
    
    // ============================================
    // SECURITY TAB
    // ============================================
    
    // Password form submit
    document.getElementById('password-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const form = e.target;
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      
      // Validate passwords match
      if (newPassword !== confirmPassword) {
        document.getElementById('confirmPassword').setCustomValidity('Las contraseñas no coinciden');
        form.classList.add('was-validated');
        return;
      } else {
        document.getElementById('confirmPassword').setCustomValidity('');
      }
      
      if (!validateForm(form)) return;
      
      const btn = document.getElementById('save-password-btn');
      setButtonLoading(btn, true, 'Cambiando contraseña...');
      
      try {
        const passwordData = {
          currentPassword: document.getElementById('currentPassword').value,
          newPassword: newPassword
        };
        
        const response = await AuthService.changePassword(passwordData);
        
        if (response.success) {
          showAlert('success', 'Contraseña actualizada correctamente');
          form.reset();
          form.classList.remove('was-validated');
        } else {
          showAlert('danger', response.message || 'Error al cambiar la contraseña');
        }
      } catch (error) {
        console.error('Error changing password:', error);
        showAlert('danger', 'Error al cambiar la contraseña');
      } finally {
        setButtonLoading(btn, false);
      }
    });
    
    // Delete account
    document.getElementById('confirm-delete-account-btn')?.addEventListener('click', async () => {
      const form = document.getElementById('delete-account-form');
      if (!validateForm(form)) return;
      
      const password = document.getElementById('deleteAccountPassword').value;
      const btn = document.getElementById('confirm-delete-account-btn');
      
      setButtonLoading(btn, true, 'Eliminando...');
      
      try {
        const response = await AuthService.deleteAccount({ password });
        
        if (response.success) {
          showAlert('success', 'Tu cuenta ha sido eliminada. Redirigiendo...');
          setTimeout(() => {
            window.location.href = '../index.html';
          }, 2000);
        } else {
          showAlert('danger', response.message || 'Error al eliminar la cuenta');
          setButtonLoading(btn, false);
        }
      } catch (error) {
        console.error('Error deleting account:', error);
        showAlert('danger', 'Error al eliminar la cuenta');
        setButtonLoading(btn, false);
      }
    });
    
    // ============================================
    // INITIALIZATION
    // ============================================
    
    document.addEventListener('DOMContentLoaded', () => {
      loadUserProfile();
      
      // Load addresses when tab is shown
      document.querySelector('a[href="#direcciones"]')?.addEventListener('shown.bs.tab', () => {
        loadAddresses();
      });
      
      // Update tab links in sidebar
      document.querySelectorAll('[data-bs-toggle="tab"]').forEach(link => {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          const tab = new bootstrap.Tab(this);
          tab.show();
          
          // Update active state in sidebar
          document.querySelectorAll('.nav-link').forEach(l => {
            l.classList.remove('active', 'bg-primary', 'bg-opacity-10', 'text-primary');
            l.classList.add('text-dark');
          });
          this.classList.remove('text-dark');
          this.classList.add('active', 'bg-primary', 'bg-opacity-10', 'text-primary');
        });
      });
    });
  </script>
  
</body>
</html>