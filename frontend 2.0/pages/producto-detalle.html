<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Detalle del producto - MarAzul">
    <title>Detalle del Producto - MarAzul</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/variables.css">
    
    <style>
        .product-image-main {
            width: 100%;
            height: 500px;
            object-fit: cover;
            border-radius: 8px;
            cursor: zoom-in;
            transition: transform 0.3s ease;
        }
        
        .product-image-main:hover {
            transform: scale(1.02);
        }
        
        .product-thumbnail {
            width: 100%;
            height: 100px;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        .product-thumbnail:hover,
        .product-thumbnail.active {
            border-color: var(--bs-primary);
            transform: scale(1.05);
        }
        
        .price-original {
            text-decoration: line-through;
            color: #6c757d;
        }
        
        .price-current {
            font-size: 2rem;
            font-weight: bold;
            color: var(--bs-primary);
        }
        
        .discount-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #dc3545;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-weight: bold;
            z-index: 10;
        }
        
        .quantity-selector {
            max-width: 150px;
        }
        
        .product-specs-table th {
            width: 40%;
            background-color: #f8f9fa;
        }
        
        /* Image zoom modal */
        .image-zoom-modal .modal-content {
            background: transparent;
            border: none;
        }
        
        .image-zoom-modal .modal-body {
            padding: 0;
        }
        
        .image-zoom-modal img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
        }
        
        .btn-wishlist.active {
            color: #dc3545 !important;
        }
    </style>
</head>
<body>
    <!-- Header Component -->
    <div id="header-container"></div>

    <!-- Breadcrumb -->
    <div class="container mt-4">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="../index.html">Inicio</a></li>
                <li class="breadcrumb-item"><a href="#" id="categoryBreadcrumb">Categoría</a></li>
                <li class="breadcrumb-item active" aria-current="page" id="productBreadcrumb">Producto</li>
            </ol>
        </nav>
    </div>

    <!-- Alert Container -->
    <div class="container">
        <div id="alert-container"></div>
    </div>

    <!-- Product Detail -->
    <div class="container my-5">
        <div class="row">
            <!-- Product Images -->
            <div class="col-lg-6 mb-4">
                <div class="position-relative mb-3">
                    <img 
                        id="mainProductImage" 
                        src="../assets/images/placeholder.jpg" 
                        alt="Producto" 
                        class="product-image-main"
                        onclick="zoomImage()"
                    >
                    <div id="discountBadge" class="discount-badge d-none">
                        -<span id="discountPercentage">0</span>%
                    </div>
                </div>
                
                <!-- Thumbnails -->
                <div class="row g-2" id="thumbnailsContainer">
                    <!-- Thumbnails will be rendered here -->
                </div>
            </div>

            <!-- Product Info -->
            <div class="col-lg-6">
                <div class="mb-3">
                    <span class="badge bg-secondary text-uppercase" id="productCategory">Categoría</span>
                </div>
                
                <h1 class="mb-3" id="productName">Nombre del Producto</h1>
                
                <!-- Rating -->
                <div class="d-flex align-items-center mb-3">
                    <div class="text-warning me-2" id="productRating" aria-label="Calificación del producto">
                        <!-- Stars will be rendered here -->
                    </div>
                    <span class="text-muted">
                        <span id="ratingValue">0</span> (<span id="reviewCount">0</span> reseñas)
                    </span>
                </div>

                <!-- Price -->
                <div class="mb-4">
                    <div id="priceOriginalContainer" class="d-none">
                        <span class="price-original h4" id="priceOriginal">$0</span>
                    </div>
                    <div class="price-current" id="priceCurrent">$0</div>
                    <p class="text-muted mb-0" id="pricePerUnit"></p>
                </div>

                <!-- Description -->
                <div class="mb-4">
                    <h5>Descripción</h5>
                    <p id="productDescription" class="text-muted">
                        Cargando descripción...
                    </p>
                </div>

                <!-- Stock Status -->
                <div class="mb-4">
                    <div class="d-flex align-items-center" id="stockStatus">
                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                    </div>
                </div>

                <!-- Quantity and Add to Cart -->
                <div class="mb-4">
                    <div class="row g-3">
                        <div class="col-auto">
                            <label for="quantity" class="form-label">Cantidad</label>
                            <div class="input-group quantity-selector">
                                <button 
                                    class="btn btn-outline-secondary" 
                                    type="button"
                                    onclick="decreaseQuantity()"
                                    aria-label="Disminuir cantidad"
                                >
                                    <i class="bi bi-dash"></i>
                                </button>
                                <input 
                                    type="number" 
                                    class="form-control text-center" 
                                    id="quantity" 
                                    value="1" 
                                    min="1"
                                    max="99"
                                    aria-label="Cantidad"
                                >
                                <button 
                                    class="btn btn-outline-secondary" 
                                    type="button"
                                    onclick="increaseQuantity()"
                                    aria-label="Aumentar cantidad"
                                >
                                    <i class="bi bi-plus"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="col">
                            <label class="form-label d-block">&nbsp;</label>
                            <button 
                                class="btn btn-primary btn-lg w-100" 
                                id="addToCartBtn"
                                onclick="addToCart()"
                            >
                                <i class="bi bi-cart-plus me-2"></i>
                                Agregar al Carrito
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Additional Actions -->
                <div class="d-flex gap-2 mb-4">
                    <button 
                        class="btn btn-outline-secondary flex-fill btn-wishlist"
                        onclick="toggleWishlist()"
                        id="wishlistBtn"
                        aria-label="Agregar a favoritos"
                    >
                        <i class="bi bi-heart me-2"></i>
                        <span id="wishlistText">Agregar a Favoritos</span>
                    </button>
                    <button 
                        class="btn btn-outline-secondary"
                        data-bs-toggle="modal"
                        data-bs-target="#shareModal"
                        aria-label="Compartir producto"
                    >
                        <i class="bi bi-share"></i>
                    </button>
                </div>

                <!-- Product Features -->
                <div class="card bg-light">
                    <div class="card-body">
                        <h6 class="card-title mb-3">
                            <i class="bi bi-check-circle text-success me-2"></i>
                            Características Destacadas
                        </h6>
                        <ul class="mb-0" id="productFeatures">
                            <li>Cargando características...</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs Section -->
        <div class="row mt-5">
            <div class="col-12">
                <ul class="nav nav-tabs" id="productTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button 
                            class="nav-link active" 
                            id="details-tab" 
                            data-bs-toggle="tab" 
                            data-bs-target="#details" 
                            type="button" 
                            role="tab"
                            aria-controls="details"
                            aria-selected="true"
                        >
                            Detalles
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button 
                            class="nav-link" 
                            id="specs-tab" 
                            data-bs-toggle="tab" 
                            data-bs-target="#specs" 
                            type="button" 
                            role="tab"
                            aria-controls="specs"
                            aria-selected="false"
                        >
                            Especificaciones
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button 
                            class="nav-link" 
                            id="reviews-tab" 
                            data-bs-toggle="tab" 
                            data-bs-target="#reviews" 
                            type="button" 
                            role="tab"
                            aria-controls="reviews"
                            aria-selected="false"
                        >
                            Reseñas (<span id="reviewCountTab">0</span>)
                        </button>
                    </li>
                </ul>
                
                <div class="tab-content p-4 border border-top-0" id="productTabsContent">
                    <!-- Details Tab -->
                    <div class="tab-pane fade show active" id="details" role="tabpanel" aria-labelledby="details-tab">
                        <h5>Información Detallada</h5>
                        <div id="detailedDescription">
                            <p>Cargando información...</p>
                        </div>
                    </div>
                    
                    <!-- Specifications Tab -->
                    <div class="tab-pane fade" id="specs" role="tabpanel" aria-labelledby="specs-tab">
                        <h5>Especificaciones Técnicas</h5>
                        <table class="table table-striped product-specs-table" id="specsTable">
                            <tbody>
                                <tr>
                                    <td colspan="2" class="text-center text-muted">Cargando especificaciones...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Reviews Tab -->
                    <div class="tab-pane fade" id="reviews" role="tabpanel" aria-labelledby="reviews-tab">
                        <div class="row">
                            <div class="col-lg-4 mb-4">
                                <div class="text-center">
                                    <h2 class="display-4 mb-0" id="avgRating">0</h2>
                                    <div class="text-warning mb-2" id="avgRatingStars">
                                        <!-- Stars will be rendered here -->
                                    </div>
                                    <p class="text-muted">Basado en <span id="totalReviews">0</span> reseñas</p>
                                </div>
                            </div>
                            
                            <div class="col-lg-8">
                                <div id="reviewsContainer">
                                    <p class="text-muted">Cargando reseñas...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Related Products -->
        <div class="row mt-5">
            <div class="col-12">
                <h3 class="mb-4">Productos Relacionados</h3>
                <div class="row g-3" id="relatedProductsContainer">
                    <!-- Related products will be rendered here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="shareModalLabel">Compartir Producto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex gap-2 mb-3">
                        <button class="btn btn-outline-primary flex-fill" onclick="shareOn('facebook')" aria-label="Compartir en Facebook">
                            <i class="bi bi-facebook me-2"></i>Facebook
                        </button>
                        <button class="btn btn-outline-info flex-fill" onclick="shareOn('twitter')" aria-label="Compartir en Twitter">
                            <i class="bi bi-twitter me-2"></i>Twitter
                        </button>
                        <button class="btn btn-outline-success flex-fill" onclick="shareOn('whatsapp')" aria-label="Compartir por WhatsApp">
                            <i class="bi bi-whatsapp me-2"></i>WhatsApp
                        </button>
                    </div>
                    <div class="input-group">
                        <input 
                            type="text" 
                            class="form-control" 
                            id="shareUrl" 
                            readonly
                            aria-label="URL para compartir"
                        >
                        <button class="btn btn-outline-secondary" onclick="copyUrl()" aria-label="Copiar URL">
                            <i class="bi bi-clipboard"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Zoom Modal -->
    <div class="modal fade image-zoom-modal" id="imageZoomModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body position-relative">
                    <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    <img id="zoomedImage" src="" alt="Imagen ampliada" class="img-fluid">
                </div>
            </div>
        </div>
    </div>

    <!-- Footer Component -->
    <div id="footer-container"></div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JS -->
    <script type="module">
        import { ProductService } from '../js/services/ProductService.js';
        import { CartService } from '../js/services/CartService.js';
        import { formatCurrency, showAlert, setButtonLoading } from '../js/utils.js';

        let currentProduct = null;
        let currentImageIndex = 0;
        let isInWishlist = false;

        // Get product ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('id');

        // Render star rating
        function renderStars(rating, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 >= 0.5;
            const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
            
            let html = '';
            for (let i = 0; i < fullStars; i++) {
                html += '<i class="bi bi-star-fill"></i>';
            }
            if (hasHalfStar) {
                html += '<i class="bi bi-star-half"></i>';
            }
            for (let i = 0; i < emptyStars; i++) {
                html += '<i class="bi bi-star"></i>';
            }
            
            container.innerHTML = html;
        }

        // Load product
        async function loadProduct() {
            if (!productId) {
                showAlert('danger', 'Producto no encontrado');
                setTimeout(() => {
                    window.location.href = '../index.html';
                }, 2000);
                return;
            }

            try {
                const response = await ProductService.getProductById(productId);
                if (response.success && response.data) {
                    currentProduct = response.data;
                    renderProduct();
                    loadRelatedProducts();
                    checkWishlistStatus();
                }
            } catch (error) {
                console.error('Error loading product:', error);
                showAlert('danger', 'Error al cargar el producto');
            }
        }

        // Render product
        function renderProduct() {
            if (!currentProduct) return;

            // Update page title and meta
            document.title = `${currentProduct.name} - MarAzul`;
            
            // Breadcrumb
            document.getElementById('categoryBreadcrumb').textContent = currentProduct.category?.name || 'Categoría';
            document.getElementById('productBreadcrumb').textContent = currentProduct.name;

            // Images
            const images = currentProduct.images || [currentProduct.mainImage || '../assets/images/placeholder.jpg'];
            document.getElementById('mainProductImage').src = images[0];
            document.getElementById('mainProductImage').alt = currentProduct.name;

            const thumbnailsContainer = document.getElementById('thumbnailsContainer');
            thumbnailsContainer.innerHTML = '';
            images.forEach((img, index) => {
                const col = document.createElement('div');
                col.className = 'col-4';
                col.innerHTML = `
                    <img 
                        src="${img}" 
                        alt="${currentProduct.name} - Imagen ${index + 1}" 
                        class="product-thumbnail ${index === 0 ? 'active' : ''}"
                        onclick="changeMainImage(${index})"
                    >
                `;
                thumbnailsContainer.appendChild(col);
            });

            // Discount badge
            if (currentProduct.discount > 0) {
                document.getElementById('discountBadge').classList.remove('d-none');
                document.getElementById('discountPercentage').textContent = currentProduct.discount;
                document.getElementById('priceOriginalContainer').classList.remove('d-none');
                document.getElementById('priceOriginal').textContent = formatCurrency(currentProduct.originalPrice);
            }

            // Basic info
            document.getElementById('productCategory').textContent = currentProduct.category?.name || 'Categoría';
            document.getElementById('productName').textContent = currentProduct.name;
            
            // Rating
            renderStars(currentProduct.rating || 0, 'productRating');
            document.getElementById('ratingValue').textContent = (currentProduct.rating || 0).toFixed(1);
            document.getElementById('reviewCount').textContent = currentProduct.reviewCount || 0;
            
            // Price
            document.getElementById('priceCurrent').textContent = formatCurrency(currentProduct.price);
            document.getElementById('pricePerUnit').textContent = `Precio por ${currentProduct.unit || 'unidad'}`;
            
            // Description
            document.getElementById('productDescription').textContent = currentProduct.description || 'Sin descripción';
            document.getElementById('detailedDescription').innerHTML = `<p>${currentProduct.detailedDescription || currentProduct.description || 'Sin información detallada'}</p>`;

            // Stock
            const stockStatus = document.getElementById('stockStatus');
            if (currentProduct.stock > 0) {
                stockStatus.innerHTML = `
                    <i class="bi bi-check-circle-fill text-success me-2"></i>
                    <span class="text-success">En stock (${currentProduct.stock} disponibles)</span>
                `;
                document.getElementById('quantity').max = currentProduct.stock;
            } else {
                stockStatus.innerHTML = `
                    <i class="bi bi-x-circle-fill text-danger me-2"></i>
                    <span class="text-danger">Sin stock</span>
                `;
                document.getElementById('addToCartBtn').disabled = true;
            }

            // Features
            const featuresList = document.getElementById('productFeatures');
            if (currentProduct.features && currentProduct.features.length > 0) {
                featuresList.innerHTML = currentProduct.features.map(f => `<li>${f}</li>`).join('');
            } else {
                featuresList.innerHTML = '<li>Producto fresco y de calidad</li>';
            }

            // Specifications
            const specsTable = document.getElementById('specsTable');
            if (currentProduct.specifications && Object.keys(currentProduct.specifications).length > 0) {
                specsTable.innerHTML = Object.entries(currentProduct.specifications)
                    .map(([key, value]) => `<tr><th>${key}</th><td>${value}</td></tr>`)
                    .join('');
            } else {
                specsTable.innerHTML = '<tr><td colspan="2" class="text-center text-muted">No hay especificaciones disponibles</td></tr>';
            }

            // Reviews
            document.getElementById('reviewCountTab').textContent = currentProduct.reviewCount || 0;
            document.getElementById('avgRating').textContent = (currentProduct.rating || 0).toFixed(1);
            document.getElementById('totalReviews').textContent = currentProduct.reviewCount || 0;
            renderStars(currentProduct.rating || 0, 'avgRatingStars');

            // Share URL
            document.getElementById('shareUrl').value = window.location.href;
        }

        // Change main image
        window.changeMainImage = function(index) {
            const images = currentProduct.images || [currentProduct.mainImage];
            currentImageIndex = index;
            document.getElementById('mainProductImage').src = images[index];
            
            document.querySelectorAll('.product-thumbnail').forEach((thumb, i) => {
                thumb.classList.toggle('active', i === index);
            });
        };

        // Zoom image
        window.zoomImage = function() {
            const mainImage = document.getElementById('mainProductImage');
            const zoomedImage = document.getElementById('zoomedImage');
            zoomedImage.src = mainImage.src;
            
            const modal = new bootstrap.Modal(document.getElementById('imageZoomModal'));
            modal.show();
        };

        // Quantity controls
        window.increaseQuantity = function() {
            const input = document.getElementById('quantity');
            const currentValue = parseInt(input.value);
            const maxValue = parseInt(input.max);
            if (currentValue < maxValue) {
                input.value = currentValue + 1;
            }
        };

        window.decreaseQuantity = function() {
            const input = document.getElementById('quantity');
            const currentValue = parseInt(input.value);
            const minValue = parseInt(input.min);
            if (currentValue > minValue) {
                input.value = currentValue - 1;
            }
        };

        // Add to cart
        window.addToCart = async function() {
            const quantity = parseInt(document.getElementById('quantity').value);
            const btn = document.getElementById('addToCartBtn');
            
            setButtonLoading(btn, true, 'Agregando...');
            
            try {
                const response = await CartService.addItem(currentProduct._id || currentProduct.id, quantity);
                
                if (response.success) {
                    showAlert('success', 'Producto agregado al carrito exitosamente');
                    // Update cart badge if exists
                    const event = new CustomEvent('cartUpdated');
                    window.dispatchEvent(event);
                } else {
                    showAlert('danger', response.message || 'Error al agregar al carrito');
                }
            } catch (error) {
                console.error('Error adding to cart:', error);
                showAlert('danger', 'Error al agregar el producto al carrito');
            } finally {
                setButtonLoading(btn, false);
            }
        };

        // Check wishlist status
        async function checkWishlistStatus() {
            try {
                // TODO: Implement wishlist check
                // const response = await WishlistService.check(currentProduct._id || currentProduct.id);
                // isInWishlist = response.data.isInWishlist;
                isInWishlist = false;
                updateWishlistButton();
            } catch (error) {
                console.error('Error checking wishlist:', error);
            }
        }

        // Update wishlist button
        function updateWishlistButton() {
            const btn = document.getElementById('wishlistBtn');
            const icon = btn.querySelector('i');
            const text = document.getElementById('wishlistText');
            
            if (isInWishlist) {
                icon.classList.remove('bi-heart');
                icon.classList.add('bi-heart-fill');
                btn.classList.add('active');
                text.textContent = 'En Favoritos';
            } else {
                icon.classList.remove('bi-heart-fill');
                icon.classList.add('bi-heart');
                btn.classList.remove('active');
                text.textContent = 'Agregar a Favoritos';
            }
        }

        // Toggle wishlist
        window.toggleWishlist = async function() {
            try {
                if (isInWishlist) {
                    // TODO: Remove from wishlist
                    // await WishlistService.remove(currentProduct._id || currentProduct.id);
                    isInWishlist = false;
                    showAlert('info', 'Producto eliminado de favoritos');
                } else {
                    // TODO: Add to wishlist
                    // await WishlistService.add(currentProduct._id || currentProduct.id);
                    isInWishlist = true;
                    showAlert('success', 'Producto agregado a favoritos');
                }
                updateWishlistButton();
            } catch (error) {
                console.error('Wishlist error:', error);
                showAlert('danger', 'Error al actualizar favoritos');
            }
        };

        // Share functions
        window.shareOn = function(platform) {
            const url = encodeURIComponent(window.location.href);
            const text = encodeURIComponent(currentProduct.name);
            
            let shareUrl = '';
            switch(platform) {
                case 'facebook':
                    shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${url}`;
                    break;
                case 'twitter':
                    shareUrl = `https://twitter.com/intent/tweet?url=${url}&text=${text}`;
                    break;
                case 'whatsapp':
                    shareUrl = `https://wa.me/?text=${text}%20${url}`;
                    break;
            }
            
            if (shareUrl) {
                window.open(shareUrl, '_blank', 'width=600,height=400');
            }
        };

        window.copyUrl = function() {
            const input = document.getElementById('shareUrl');
            input.select();
            input.setSelectionRange(0, 99999);
            
            navigator.clipboard.writeText(input.value).then(() => {
                showAlert('success', 'URL copiada al portapapeles');
            }).catch(() => {
                document.execCommand('copy');
                showAlert('success', 'URL copiada al portapapeles');
            });
        };

        // Load related products
        async function loadRelatedProducts() {
            try {
                // TODO: Load actual related products
                const container = document.getElementById('relatedProductsContainer');
                container.innerHTML = '<p class="text-muted">Cargando productos relacionados...</p>';
            } catch (error) {
                console.error('Error loading related products:', error);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadProduct();
        });
    </script>
</body>
</html>