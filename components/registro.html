<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Registro — MarAzul</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="/MARAZUL/MARAZUL/css/style.css">
  <style>
    .card-register { max-width: 520px; margin: 36px auto; }
  </style>
</head>
<body>
  <div id="header-container"></div>

  <main class="container">
    <div class="card card-register shadow-sm">
      <div class="card-body">
        <h5 class="card-title text-center mb-3">Crear cuenta</h5>

        <form id="registerForm">
            <div class="mb-3">
                <label class="form-label">Email</label>
                <input id="regEmail" type="email" class="form-control" required>
                <div id="regEmailError" class="invalid-feedback d-none"></div>
            </div>

            <div class="row g-2">
                <div class="col-md-6 mb-3">
                <label class="form-label">Nombre</label>
                <input id="regFirstName" type="text" class="form-control" required>
                </div>
                <div class="col-md-6 mb-3">
                <label class="form-label">Apellido</label>
                <input id="regLastName" type="text" class="form-control" required>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label">Teléfono</label>
                <div class="input-group">
                <span class="input-group-text">+56</span>
                <input id="regPhone" type="tel" class="form-control" pattern="[0-9]{8,9}" required>
                </div>
                <div class="form-text">Ej: 912345678</div>
            </div>

            <div class="row g-2">
                <div class="col-md-6 mb-3">
                <label class="form-label">Contraseña</label>
                <input id="regPass" type="password" class="form-control" required>
                </div>
                <div class="col-md-6 mb-3">
                <label class="form-label">Repetir contraseña</label>
                <input id="regPass2" type="password" class="form-control" required>
                <div id="regPassError" class="invalid-feedback d-none"></div>
                </div>
            </div>

            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary flex-grow-1">Crear cuenta</button>
                <a class="btn btn-outline-secondary" href="/MARAZUL/MARAZUL/components/login.html">Volver</a>
            </div>
        </form>

      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/MARAZUL/MARAZUL/js/header.js"></script>
<script>
  const BASE = '/MARAZUL/MARAZUL';

  function loadComponent(containerId, filePath, callback) {
    fetch(filePath)
      .then(res => { if (!res.ok) throw new Error("HTTP " + res.status); return res.text(); })
      .then(html => { document.getElementById(containerId).innerHTML = html; if (typeof callback === "function") callback(); })
      .catch(err => console.error("Error al cargar " + filePath, err));
  }
  loadComponent("header-container", BASE + "/components/header.html", () => { if (typeof initHeader === 'function') initHeader(); });

  function getUsers(){ return JSON.parse(localStorage.getItem('marazul_users') || '[]'); }
  function saveUsers(u){ localStorage.setItem('marazul_users', JSON.stringify(u)); }

  // Pre-fill email si viene por querystring (?email=...)
  function qs(key){
    const params = new URLSearchParams(location.search);
    return params.get(key) || '';
  }

  document.addEventListener('DOMContentLoaded', () => {
    const regEmail       = document.getElementById('regEmail');
    const regFirstName   = document.getElementById('regFirstName');
    const regLastName    = document.getElementById('regLastName');
    const regPhone       = document.getElementById('regPhone');
    const regPass        = document.getElementById('regPass');
    const regPass2       = document.getElementById('regPass2');
    const regForm        = document.getElementById('registerForm');
    const regEmailError  = document.getElementById('regEmailError');
    const regPassError   = document.getElementById('regPassError');

    const pre = qs('email');
    if (pre) regEmail.value = decodeURIComponent(pre);

    regForm.addEventListener('submit', (ev) => {
      ev.preventDefault();
      regEmailError.classList.add('d-none');
      regPassError.classList.add('d-none');

      const email     = regEmail.value.trim().toLowerCase();
      const firstName = regFirstName.value.trim();
      const lastName  = regLastName.value.trim();
      const phone     = regPhone.value.trim();
      const pass      = regPass.value;
      const pass2     = regPass2.value;

      if (!email) {
        regEmailError.textContent = 'Email inválido';
        regEmailError.classList.remove('d-none');
        return;
      }
      if (!firstName || !lastName) {
        alert("Debes ingresar nombre y apellido.");
        return;
      }
      if (!/^[0-9]{8,9}$/.test(phone)) {
        alert("Teléfono inválido. Debe tener 8 o 9 dígitos sin incluir el +56.");
        return;
      }
      if (pass.length < 6) {
        regPassError.textContent = 'La contraseña debe tener al menos 6 caracteres';
        regPassError.classList.remove('d-none');
        return;
      }
      if (pass !== pass2) {
        regPassError.textContent = 'Las contraseñas no coinciden';
        regPassError.classList.remove('d-none');
        return;
      }

      const users = getUsers();
      if (users.find(u => u.email === email)) {
        regEmailError.textContent = 'Este email ya está registrado. Ve a Iniciar sesión.';
        regEmailError.classList.remove('d-none');
        return;
      }

      // Guardamos usuario (mock). En producción: usar backend seguro.
      users.push({
        email,
        password: pass,
        name: firstName + " " + lastName,
        phone
      });
      saveUsers(users);

      alert('Usuario creado correctamente. Ahora puedes iniciar sesión.');

      // redirigir a login con email precargado
      window.location.href = BASE + '/components/login.html?email=' + encodeURIComponent(email);
    });
  });
</script>

</body>
</html>
