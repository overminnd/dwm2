#!/bin/bash

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# SCRIPT DE TEST - BACKEND FILTRO POR CATEGORรA
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# 
# Uso: bash test-backend-filtros.sh
#
# Requisitos:
# - Backend corriendo en http://localhost:5000
# - curl instalado
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

API_URL="http://localhost:5000/api"
CATEGORY_ID="69252cbdfd7c80f34d4cb2f6"  # Mariscos Frescos (ajustar segรบn tu BD)

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐งช TEST BACKEND - FILTROS DE PRODUCTOS"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# TEST 1: Verificar que el backend estรก corriendo
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo "๐ก TEST 1: Verificando conexiรณn con backend..."
response=$(curl -s -o /dev/null -w "%{http_code}" $API_URL/products)

if [ "$response" = "200" ]; then
  echo "โ Backend disponible (HTTP 200)"
else
  echo "โ Backend no disponible (HTTP $response)"
  echo "   Ejecuta: cd backend && npm run dev"
  exit 1
fi
echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# TEST 2: Productos sin filtro (todos)
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo "๐ฆ TEST 2: Obtener TODOS los productos..."
response=$(curl -s "$API_URL/products?limit=100")

total=$(echo $response | grep -o '"totalProducts":[0-9]*' | grep -o '[0-9]*')
count=$(echo $response | grep -o '"data":\[' | wc -l)

if [ ! -z "$total" ]; then
  echo "โ Total de productos en BD: $total"
else
  echo "โ No se pudo obtener el total de productos"
fi
echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# TEST 3: Filtro por categoryId (NUEVO - debe funcionar)
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo "๐ TEST 3: Filtrar por categoryId (ObjectId directo)..."
echo "   Request: GET /products?categoryId=$CATEGORY_ID&limit=12"

response=$(curl -s "$API_URL/products?categoryId=$CATEGORY_ID&limit=12")

# Contar productos en la respuesta
count=$(echo $response | grep -o '"_id"' | wc -l)

if [ "$count" -gt 0 ]; then
  echo "โ Filtro por categoryId funciona: $count productos encontrados"
else
  echo "โ Filtro por categoryId NO funciona (0 productos)"
  echo "   Verifica que el backend soporte el parรกmetro 'categoryId'"
fi
echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# TEST 4: Filtro por category slug (backward compatibility)
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo "๐ TEST 4: Filtrar por category (slug)..."
echo "   Request: GET /products?category=pescado&limit=12"

response=$(curl -s "$API_URL/products?category=pescado&limit=12")
count=$(echo $response | grep -o '"_id"' | wc -l)

if [ "$count" -gt 0 ]; then
  echo "โ Filtro por category (slug) funciona: $count productos encontrados"
else
  echo "โ๏ธ  Filtro por category (slug) no retornรณ productos"
fi
echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# TEST 5: Productos destacados
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo "๐ TEST 5: Filtrar productos destacados..."
echo "   Request: GET /products?featured=true&limit=10"

response=$(curl -s "$API_URL/products?featured=true&limit=10")
count=$(echo $response | grep -o '"_id"' | wc -l)

if [ "$count" -gt 0 ]; then
  echo "โ Filtro por featured funciona: $count productos destacados"
else
  echo "โ๏ธ  No hay productos destacados en la BD"
fi
echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# TEST 6: Combinaciรณn de filtros
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo "๐ฏ TEST 6: Combinaciรณn categoryId + featured..."
echo "   Request: GET /products?categoryId=$CATEGORY_ID&featured=true"

response=$(curl -s "$API_URL/products?categoryId=$CATEGORY_ID&featured=true")
count=$(echo $response | grep -o '"_id"' | wc -l)

if [ "$count" -gt 0 ]; then
  echo "โ Combinaciรณn de filtros funciona: $count productos"
else
  echo "โ๏ธ  No hay productos con ambos filtros"
fi
echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# RESUMEN
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐ RESUMEN DE TESTS"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""
echo "TEST CRรTICO: Filtro por categoryId"
echo "  โ Si muestra โ, el backend estรก corregido"
echo "  โ Si muestra โ, aplica las instrucciones de INSTRUCCIONES_CORRECCION.md"
echo ""
echo "Para ver logs detallados del backend, revisa la consola donde ejecutaste 'npm run dev'"
echo ""